{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-slate-800">{{ title }}</h2>
    <a href="/patients" class="btn btn-secondary">â† Retour</a>
  </div>

  <form method="post" action="{{ action_url }}" class="space-y-6">
    <div class="form-grid grid gap-4 md:gap-6">
    
    <!-- AccordÃ©on IdentitÃ© -->
    <details class="bg-white rounded-xl border border-slate-200 overflow-hidden" open>
      <summary class="cursor-pointer bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 font-semibold text-slate-800 hover:from-blue-100 hover:to-blue-200 transition-colors">
        <span class="text-lg">ğŸ‘¤ IdentitÃ©</span>
      </summary>
      <div class="p-6 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              NumÃ©ro de sÃ©quence <span class="text-red-500">*</span>
            </label>
            <input type="number" name="patient_seq" value="{{ patient.patient_seq if patient else next_seq }}" 
                   required class="input-field" placeholder="Auto">
            <p class="text-xs text-slate-500 mt-1">Identifiant sÃ©quentiel unique</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">External ID (SI source)</label>
            <input type="text" name="external_id" value="{{ patient.external_id if patient else (sample_data.external_id if sample_data else '') }}" 
                   class="input-field" placeholder="Ex: PAT123456">
            <p class="text-xs text-slate-500 mt-1">Identifiant du systÃ¨me externe</p>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              CivilitÃ©
            </label>
            <select name="prefix" class="input-field">
              <option value="">-- Choisir --</option>
              <option value="M." {% if (patient and patient.prefix == 'M.') or (not patient and sample_data and sample_data.prefix == 'M.') %}selected{% endif %}>M. (Monsieur)</option>
              <option value="Mme" {% if (patient and patient.prefix == 'Mme') or (not patient and sample_data and sample_data.prefix == 'Mme') %}selected{% endif %}>Mme (Madame)</option>
              <option value="Mlle" {% if (patient and patient.prefix == 'Mlle') or (not patient and sample_data and sample_data.prefix == 'Mlle') %}selected{% endif %}>Mlle (Mademoiselle)</option>
            </select>
          </div>
          <div class="col-span-2"></div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" for="family">
              Nom <span class="text-red-500">*</span>
            </label>
            <input type="text" id="family" name="family" value="{{ patient.family if patient else (sample_data.family if sample_data else '') }}"
                   required aria-required="true" data-required="true" aria-invalid="{{ 'true' if not patient or not patient.family }}"
                   class="input-field{% if not patient or not patient.family %} border-red-500{% endif %}"
                   placeholder="MARTIN">
            {% if not patient or not patient.family %}
            <p class="error-message form-error text-sm text-red-600 flex items-center gap-1 mt-1" data-for="family">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Ce champ est obligatoire
            </p>
            {% endif %}
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
              Nom de naissance (nom de jeune fille)
            </label>
            <input type="text" name="birth_family" value="{{ patient.birth_family if patient else (sample_data.birth_family if sample_data else '') }}" 
                   class="input-field" placeholder="DUPONT">
            <p class="text-xs text-slate-500 mt-1">PID-5 type L - Si diffÃ©rent du nom actuel</p>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1" for="given">
              PrÃ©nom <span class="text-red-500">*</span>
            </label>
            <input type="text" id="given" name="given" value="{{ patient.given if patient else (sample_data.given if sample_data else '') }}"
                   required aria-required="true" data-required="true" aria-invalid="{{ 'true' if not patient or not patient.given }}"
                   class="input-field{% if not patient or not patient.given %} border-red-500{% endif %}"
                   placeholder="Sophie">
            {% if not patient or not patient.given %}
            <p class="error-message form-error text-sm text-red-600 flex items-center gap-1 mt-1" data-for="given">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Ce champ est obligatoire
            </p>
            {% endif %}
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
              DeuxiÃ¨me prÃ©nom
            </label>
            <input type="text" name="middle" value="{{ patient.middle if patient else (sample_data.middle if sample_data else '') }}" 
                   class="input-field" placeholder="Marie">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
              Suffixe
            </label>
            <input type="text" name="suffix" value="{{ patient.suffix if patient else (sample_data.suffix if sample_data else '') }}" 
                   class="input-field" placeholder="Jr., III, etc.">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Date de naissance
            </label>
            <input type="date" name="birth_date" value="{{ patient.birth_date if patient else (sample_data.birth_date if sample_data else '') }}" 
                   class="input-field">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Sexe administratif
            </label>
            <select name="gender" class="input-field">
              <option value="">-- Choisir --</option>
              <option value="M" {% if (patient and patient.gender == 'M') or (not patient and sample_data and sample_data.gender == 'M') %}selected{% endif %}>Masculin</option>
              <option value="F" {% if (patient and patient.gender == 'F') or (not patient and sample_data and sample_data.gender == 'F') %}selected{% endif %}>FÃ©minin</option>
              <option value="U" {% if (patient and patient.gender == 'U') or (not patient and sample_data and sample_data.gender == 'U') %}selected{% endif %}>IndÃ©terminÃ©</option>
              <option value="O" {% if (patient and patient.gender == 'O') or (not patient and sample_data and sample_data.gender == 'O') %}selected{% endif %}>Autre</option>
            </select>
          </div>
        </div>
      </div>
    </details>

    <!-- AccordÃ©on CoordonnÃ©es -->
    <details class="bg-white rounded-xl border border-slate-200 overflow-hidden" open>
      <summary class="cursor-pointer bg-gradient-to-r from-green-50 to-green-100 px-6 py-4 font-semibold text-slate-800 hover:from-green-100 hover:to-green-200 transition-colors">
        <span class="text-lg">ğŸ“ CoordonnÃ©es (domicile)</span>
      </summary>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Adresse</label>
          <input type="text" name="address" value="{{ patient.address if patient else (sample_data.address if sample_data else '') }}" 
                 class="input-field" placeholder="15 rue Victor Hugo">
          <p class="text-xs text-slate-500 mt-1">NumÃ©ro et rue - PID-11.1</p>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Ville</label>
            <input type="text" name="city" value="{{ patient.city if patient else (sample_data.city if sample_data else '') }}" 
                   class="input-field" placeholder="Paris">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Code postal</label>
            <input type="text" name="postal_code" value="{{ patient.postal_code if patient else (sample_data.postal_code if sample_data else '') }}" 
                   class="input-field" placeholder="75001">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">DÃ©partement/Ã‰tat</label>
            <input type="text" name="state" value="{{ patient.state if patient else (sample_data.state if sample_data else '') }}" 
                   class="input-field" placeholder="Ãle-de-France">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Pays</label>
          <select name="country" class="input-field">
            <option value="">-- Choisir --</option>
            <option value="FRA" {% if (patient and patient.country == 'FRA') or (not patient and sample_data and sample_data.country == 'FRA') %}selected{% endif %}>ğŸ‡«ğŸ‡· France (FRA)</option>
            <option value="BEL" {% if (patient and patient.country == 'BEL') or (not patient and sample_data and sample_data.country == 'BEL') %}selected{% endif %}>ğŸ‡§ğŸ‡ª Belgique (BEL)</option>
            <option value="CHE" {% if (patient and patient.country == 'CHE') or (not patient and sample_data and sample_data.country == 'CHE') %}selected{% endif %}>ğŸ‡¨ğŸ‡­ Suisse (CHE)</option>
            <option value="LUX" {% if (patient and patient.country == 'LUX') or (not patient and sample_data and sample_data.country == 'LUX') %}selected{% endif %}>ğŸ‡±ğŸ‡º Luxembourg (LUX)</option>
            <option value="DEU" {% if (patient and patient.country == 'DEU') or (not patient and sample_data and sample_data.country == 'DEU') %}selected{% endif %}>ğŸ‡©ğŸ‡ª Allemagne (DEU)</option>
            <option value="ITA" {% if (patient and patient.country == 'ITA') or (not patient and sample_data and sample_data.country == 'ITA') %}selected{% endif %}>ğŸ‡®ğŸ‡¹ Italie (ITA)</option>
            <option value="ESP" {% if (patient and patient.country == 'ESP') or (not patient and sample_data and sample_data.country == 'ESP') %}selected{% endif %}>ğŸ‡ªğŸ‡¸ Espagne (ESP)</option>
            <option value="GBR" {% if (patient and patient.country == 'GBR') or (not patient and sample_data and sample_data.country == 'GBR') %}selected{% endif %}>ğŸ‡¬ğŸ‡§ Royaume-Uni (GBR)</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">Code ISO 3 lettres - PID-11.6</p>
        </div>

        <div class="border-t pt-4 mt-4">
          <h4 class="font-medium text-slate-700 mb-3">ğŸ“ TÃ©lÃ©phones (PID-13 multi-valuÃ©)</h4>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">TÃ©lÃ©phone fixe</label>
              <input type="tel" name="phone" value="{{ patient.phone if patient else (sample_data.phone if sample_data else '') }}" 
                     class="input-field" placeholder="0123456789">
              <p class="text-xs text-slate-500 mt-1">Principal</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Mobile</label>
              <input type="tel" name="mobile" value="{{ patient.mobile if patient else (sample_data.mobile if sample_data else '') }}" 
                     class="input-field" placeholder="0612345678">
              <p class="text-xs text-slate-500 mt-1">Type CP/CELL</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">TÃ©lÃ©phone pro</label>
              <input type="tel" name="work_phone" value="{{ patient.work_phone if patient else (sample_data.work_phone if sample_data else '') }}" 
                     class="input-field" placeholder="0498765432">
              <p class="text-xs text-slate-500 mt-1">Type WP/WORK</p>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1" for="email">Email</label>
          <input type="email" id="email" name="email" value="{{ patient.email if patient else (sample_data.email if sample_data else '') }}"
                 class="input-field" placeholder="sophie.martin@example.com"
                 aria-describedby="email_help">
          <p id="email_help" class="text-xs text-slate-500 mt-1">Adresse email du patient (optionnelle)</p>
        </div>
      </div>
    </details>

    <!-- AccordÃ©on Lieu de naissance -->
    <details class="bg-white rounded-xl border border-slate-200 overflow-hidden">
      <summary class="cursor-pointer bg-gradient-to-r from-purple-50 to-purple-100 px-6 py-4 font-semibold text-slate-800 hover:from-purple-100 hover:to-purple-200 transition-colors">
        <span class="text-lg">ğŸ¥ Lieu de naissance</span>
      </summary>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Adresse de naissance</label>
          <input type="text" name="birth_address" value="{{ patient.birth_address if patient else (sample_data.birth_address if sample_data else '') }}" 
                 class="input-field" placeholder="MaternitÃ© de la Croix-Rousse">
          <p class="text-xs text-slate-500 mt-1">Ã‰tablissement/Rue - PID-11 rÃ©pÃ©tition 2</p>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Ville de naissance</label>
            <input type="text" name="birth_city" value="{{ patient.birth_city if patient else (sample_data.birth_city if sample_data else '') }}" 
                   class="input-field" placeholder="Lyon">
            <p class="text-xs text-slate-500 mt-1">PID-23</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">DÃ©partement/RÃ©gion</label>
            <input type="text" name="birth_state" value="{{ patient.birth_state if patient else (sample_data.birth_state if sample_data else '') }}" 
                   class="input-field" placeholder="RhÃ´ne">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Code postal</label>
            <input type="text" name="birth_postal_code" value="{{ patient.birth_postal_code if patient else (sample_data.birth_postal_code if sample_data else '') }}" 
                   class="input-field" placeholder="69004">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Pays de naissance</label>
          <select name="birth_country" class="input-field">
            <option value="">-- Choisir --</option>
            <option value="FRA" {% if (patient and patient.birth_country == 'FRA') or (not patient and sample_data and sample_data.birth_country == 'FRA') %}selected{% endif %}>ğŸ‡«ğŸ‡· France (FRA)</option>
            <option value="BEL" {% if (patient and patient.birth_country == 'BEL') or (not patient and sample_data and sample_data.birth_country == 'BEL') %}selected{% endif %}>ğŸ‡§ğŸ‡ª Belgique (BEL)</option>
            <option value="CHE" {% if (patient and patient.birth_country == 'CHE') or (not patient and sample_data and sample_data.birth_country == 'CHE') %}selected{% endif %}>ğŸ‡¨ğŸ‡­ Suisse (CHE)</option>
            <option value="LUX" {% if (patient and patient.birth_country == 'LUX') or (not patient and sample_data and sample_data.birth_country == 'LUX') %}selected{% endif %}>ğŸ‡±ğŸ‡º Luxembourg (LUX)</option>
            <option value="DEU" {% if (patient and patient.birth_country == 'DEU') or (not patient and sample_data and sample_data.birth_country == 'DEU') %}selected{% endif %}>ğŸ‡©ğŸ‡ª Allemagne (DEU)</option>
            <option value="ITA" {% if (patient and patient.birth_country == 'ITA') or (not patient and sample_data and sample_data.birth_country == 'ITA') %}selected{% endif %}>ğŸ‡®ğŸ‡¹ Italie (ITA)</option>
            <option value="ESP" {% if (patient and patient.birth_country == 'ESP') or (not patient and sample_data and sample_data.birth_country == 'ESP') %}selected{% endif %}>ğŸ‡ªğŸ‡¸ Espagne (ESP)</option>
            <option value="GBR" {% if (patient and patient.birth_country == 'GBR') or (not patient and sample_data and sample_data.birth_country == 'GBR') %}selected{% endif %}>ğŸ‡¬ğŸ‡§ Royaume-Uni (GBR)</option>
          </select>
        </div>
      </div>
    </details>

    <!-- AccordÃ©on Informations administratives -->
    <details class="bg-white rounded-xl border border-slate-200 overflow-hidden">
      <summary class="cursor-pointer bg-gradient-to-r from-amber-50 to-amber-100 px-6 py-4 font-semibold text-slate-800 hover:from-amber-100 hover:to-amber-200 transition-colors">
        <span class="text-lg">ğŸ“‹ Informations administratives</span>
      </summary>
      <div class="p-6 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">NIR (NumÃ©ro de sÃ©curitÃ© sociale)</label>
            <input type="text" name="nir" value="{{ patient.nir if patient else (sample_data.nir if sample_data else '') }}" 
                   class="input-field" placeholder="1 85 06 75 123 456 78" maxlength="21">
            <p class="text-xs text-slate-500 mt-1">15 chiffres - PID-3 type NH</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Statut marital</label>
            <select name="marital_status" class="input-field">
              <option value="">-- Choisir --</option>
              <option value="S" {% if (patient and patient.marital_status == 'S') or (not patient and sample_data and sample_data.marital_status == 'S') %}selected{% endif %}>S - CÃ©libataire</option>
              <option value="M" {% if (patient and patient.marital_status == 'M') or (not patient and sample_data and sample_data.marital_status == 'M') %}selected{% endif %}>M - MariÃ©(e)</option>
              <option value="D" {% if (patient and patient.marital_status == 'D') or (not patient and sample_data and sample_data.marital_status == 'D') %}selected{% endif %}>D - DivorcÃ©(e)</option>
              <option value="W" {% if (patient and patient.marital_status == 'W') or (not patient and sample_data and sample_data.marital_status == 'W') %}selected{% endif %}>W - Veuf/Veuve</option>
              <option value="P" {% if (patient and patient.marital_status == 'P') or (not patient and sample_data and sample_data.marital_status == 'P') %}selected{% endif %}>P - Partenariat/PACS</option>
              <option value="A" {% if (patient and patient.marital_status == 'A') or (not patient and sample_data and sample_data.marital_status == 'A') %}selected{% endif %}>A - SÃ©parÃ©(e)</option>
              <option value="U" {% if (patient and patient.marital_status == 'U') or (not patient and sample_data and sample_data.marital_status == 'U') %}selected{% endif %}>U - Non spÃ©cifiÃ©</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">NationalitÃ©</label>
            <input type="text" name="nationality" value="{{ patient.nationality if patient else (sample_data.nationality if sample_data else '') }}" 
                   class="input-field" placeholder="FRA">
            <p class="text-xs text-slate-500 mt-1">Code pays ISO (ex: FRA, BEL, CHE)</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              FiabilitÃ© de l'identitÃ© (PID-32)
            </label>
            <select name="identity_reliability_code" class="input-field">
              <option value="">-- Choisir --</option>
              <option value="VIDE" {% if (patient and patient.identity_reliability_code == 'VIDE') or (not patient and sample_data and sample_data.identity_reliability_code == 'VIDE') %}selected{% endif %}>VIDE - IdentitÃ© vÃ©rifiÃ©e (INS validÃ©)</option>
              <option value="VALI" {% if (patient and patient.identity_reliability_code == 'VALI') or (not patient and sample_data and sample_data.identity_reliability_code == 'VALI') %}selected{% endif %}>VALI - ValidÃ© par piÃ¨ce d'identitÃ©</option>
              <option value="PROV" {% if (patient and patient.identity_reliability_code == 'PROV') or (not patient and sample_data and sample_data.identity_reliability_code == 'PROV') %}selected{% endif %}>PROV - Provisoire</option>
              <option value="DOUTE" {% if (patient and patient.identity_reliability_code == 'DOUTE') or (not patient and sample_data and sample_data.identity_reliability_code == 'DOUTE') %}selected{% endif %}>DOUTE - IdentitÃ© douteuse</option>
              <option value="FICTI" {% if (patient and patient.identity_reliability_code == 'FICTI') or (not patient and sample_data and sample_data.identity_reliability_code == 'FICTI') %}selected{% endif %}>FICTI - Fictive (test)</option>
            </select>
            <p class="text-xs text-slate-500 mt-1">HL7 Table 0445 - Obligatoire IHE PAM France</p>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Nom de jeune fille de la mÃ¨re</label>
            <input type="text" name="mothers_maiden_name" value="{{ patient.mothers_maiden_name if patient else (sample_data.mothers_maiden_name if sample_data else '') }}" 
                   class="input-field" placeholder="LEFEBVRE">
            <p class="text-xs text-slate-500 mt-1">UtilisÃ© pour vÃ©rification d'identitÃ©</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">MÃ©decin traitant</label>
            <input type="text" name="primary_care_provider" value="{{ patient.primary_care_provider if patient else (sample_data.primary_care_provider if sample_data else '') }}" 
                   class="input-field" placeholder="Dr. DURAND">
          </div>
        </div>
      </div>
    </details>

    <!-- Boutons d'action -->
    <div class="flex gap-3 pt-4">
      <button type="submit" class="btn btn-primary">
        ğŸ’¾ Enregistrer
      </button>
      <a href="/patients" class="btn btn-secondary">
        âœ– Annuler
      </a>
    </div>
    </div>
  </form>

  <!-- Note RGPD -->
  <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
    <strong>â„¹ï¸ ConformitÃ© RGPD France :</strong> Les donnÃ©es sensibles (race, religion) ne sont pas collectÃ©es conformÃ©ment Ã  la rÃ©glementation franÃ§aise (Article 9 RGPD + loi Informatique et LibertÃ©s).
  </div>
</div>

<style>
  details summary::-webkit-details-marker {
    display: none;
  }
  details summary::before {
    content: 'â–¶';
    display: inline-block;
    margin-right: 0.5rem;
    transition: transform 0.2s;
  }
  details[open] summary::before {
    transform: rotate(90deg);
  }
</style>
{% endblock %}
