{% extends "base.html" %}
{% block content %}
<div class="space-y-8">
  <header class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
    <h1 class="text-3xl font-semibold text-slate-900">Guide d’exploitation – MedData Bridge</h1>
    <p class="mt-3 text-sm text-slate-600 max-w-3xl">
      Ce guide s’adresse aux experts en interopérabilité (IHE PAM France, HL7 v2.x, FHIR R4) responsables de la
      qualification des échanges au sein du GHT. Il décrit les flux pris en charge, les procédures d’exploitation et
      les points de contrôle proposés par l’IHM.
    </p>
  </header>

  <section class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
    <h2 id="toc" class="text-xl font-semibold text-slate-900 mb-4">Table des matières</h2>
    <ol class="list-decimal pl-5 space-y-2 text-sm text-slate-700">
      <li><a class="text-blue-600 hover:text-blue-500" href="#scope">Périmètre &amp; architecture</a></li>
      <li><a class="text-blue-600 hover:text-blue-500" href="#prereq">Pré-requis techniques</a></li>
      <li><a class="text-blue-600 hover:text-blue-500" href="#datasets">Initialisation des référentiels</a></li>
      <li><a class="text-blue-600 hover:text-blue-500" href="#scenarios">Gestion des scénarios IHE PAM</a></li>
      <li><a class="text-blue-600 hover:text-blue-500" href="#workflow">Pilotage du workflow patient</a></li>
      <li><a class="text-blue-600 hover:text-blue-500" href="#endpoints">Interopération &amp; supervision</a></li>
      <li><a class="text-blue-600 hover:text-blue-500" href="#troubleshooting">Gestion des incidents</a></li>
      <li><a class="text-blue-600 hover:text-blue-500" href="#references">Références croisées</a></li>
    </ol>
  </section>

  <section id="scope" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-4">
    <h2 class="text-xl font-semibold text-slate-900">1. Périmètre &amp; architecture</h2>
    <p class="text-sm text-slate-700 leading-6">
      MedData Bridge orchestre les échanges d’un environnement de test GHT. Le socle couvre (i) l’ingestion des
      structures hospitalières (MFN/MFK, FHIR Location), (ii) l’exécution et le rejouement de scénarios HL7 conformes
      à la matrice IHE PAM France 2.8, et (iii) la publication multi-protocoles vers des systèmes cibles MLLP ou FHIR.
    </p>
    <dl class="grid md:grid-cols-2 gap-4 text-sm text-slate-700">
      <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
        <dt class="font-semibold text-slate-900">Flux entrants</dt>
        <dd class="mt-2 space-y-1">
          <p>HL7 ADT (A01/A03/A05/A06/A07/A11/A12/A13/A21/A22/A38/A54) via <code>on_message_inbound</code>.</p>
          <p>Extensions Z99 (mise à jour partielle) avec création automatique des entités manquantes.</p>
          <p>Scripts CLI : <code>tools/init_interop_scenarios.py</code>, <code>tools/init_vocabulaires.py</code>.</p>
        </dd>
      </div>
      <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
        <dt class="font-semibold text-slate-900">Flux sortants</dt>
        <dd class="mt-2 space-y-1">
          <p>HL7 PAM générés à partir des mouvements et scénarios (<code>emit_on_create</code>, <code>scenario_runner</code>).</p>
          <p>Bundles FHIR R4 (Patient, Encounter, Location) vers les endpoints HTTP configurés.</p>
          <p>Journalisation exhaustive dans <code>MessageLog</code> (payload, ACK/NACK, latence, endpoint.</p>
        </dd>
      </div>
    </dl>
  </section>

  <section id="prereq" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-4">
    <h2 class="text-xl font-semibold text-slate-900">2. Pré-requis techniques</h2>
    <div class="grid md:grid-cols-2 gap-4 text-sm text-slate-700">
      <div>
        <h3 class="font-semibold text-slate-800 uppercase tracking-wide text-xs">Stack logicielle</h3>
        <ul class="list-disc pl-5 space-y-1">
          <li>Python 3.10+, FastAPI, SQLModel (SQLite fourni, migrable vers PostgreSQL).</li>
          <li>Serveur MLLP de test (facultatif) pour valider les ACK externes.</li>
          <li>Serveur FHIR R4 acceptant les transactions <code>Bundle</code> (auth Basic ou token Bearer).</li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-slate-800 uppercase tracking-wide text-xs">Variables d’environnement</h3>
        <ul class="list-disc pl-5 space-y-1">
          <li><code>DATABASE_URL</code> : URL de connexion SQLModel (sinon <code>sqlite:///./poc.db</code>).</li>
          <li><code>MLLP_TRACE=1</code> : trace hexadécimale des trames envoyées / reçues.</li>
          <li><code>TESTING=1</code> : désactive l’obligation d’avoir un contexte GHT actif (CI/CD).</li>
          <li><code>FHIR_VERIFY_SSL=0</code> : autorise les certificats auto-signés.</li>
        </ul>
      </div>
    </div>
    <div class="border border-blue-200 bg-blue-50 rounded-xl p-4 text-xs text-blue-900">
      <p class="font-semibold">CLI – Mise en route</p>
      <pre class="mt-2 bg-slate-900 text-slate-100 rounded-xl p-3 overflow-auto"><code>python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
PYTHONPATH=. python tools/init_vocabulaires.py
PYTHONPATH=. python tools/init_interop_scenarios.py --base Doc/interfaces.integration_src/interfaces.integration/src/main/resources/data
PYTHONPATH=. uvicorn app.app:create_app --factory --reload</code></pre>
    </div>
  </section>

  <section id="datasets" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-6">
    <h2 class="text-xl font-semibold text-slate-900">3. Initialisation des référentiels</h2>
    <article class="space-y-3 text-sm text-slate-700">
      <h3 class="font-semibold text-slate-800">3.1 Contexte GHT</h3>
      <p>
        Naviguer vers <strong>Administration → Contextes GHT</strong> pour activer le contexte cible
        (<code>GHT-DEMO-INTEROP</code> après import). Les listes patients/dossiers/venues ainsi que les rejouements seront
        filtrés sur ce contexte.
      </p>
    </article>
    <article class="space-y-3 text-sm text-slate-700">
      <h3 class="font-semibold text-slate-800">3.2 Structure hospitalière</h3>
      <ul class="list-disc pl-5 space-y-1">
        <li>Import HL7 MFN^M05 via <strong>/messages/send</strong> (mode MLLP, copier le message MFN).</li>
        <li>Import FHIR : <strong>/fhir_structure/upload</strong> accepte un bundle <code>Location</code> hiérarchique.</li>
        <li>Les messages Z99 qui référencent une structure inconnue déclenchent la création automatique des entités (patient, dossier, venue, mouvement) afin de ne jamais interrompre la synchronisation.</li>
      </ul>
    </article>
    <article class="space-y-3 text-sm text-slate-700">
      <h3 class="font-semibold text-slate-800">3.3 Vocabulaires</h3>
      <p>
        <code>tools/init_vocabulaires.py</code> alimente les terminologies (genre, type d’UF, status de lit) ainsi que les mappings
        HL7 ↔ FHIR. L’interface <strong>/vocabularies</strong> permet la consultation et la mise à jour.
      </p>
    </article>
  </section>

  <section id="scenarios" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-6">
    <h2 class="text-xl font-semibold text-slate-900">4. Gestion des scénarios IHE PAM</h2>
    <div class="grid md:grid-cols-2 gap-4 text-sm text-slate-700">
      <div class="space-y-3">
        <h3 class="font-semibold text-slate-800">4.1 Catalogue</h3>
        <ul class="list-disc pl-5 space-y-1">
          <li><strong>/scenarios</strong> : liste complète, profil PAM, nombre de messages, protocole.</li>
          <li><strong>ScenarioBinding</strong> relie chaque scénario à un dossier démo (créé automatiquement par le script d’import).</li>
          <li>Les scénarios restent rejouables même après réimport (les liaisons sont recalculées si nécessaire).</li>
        </ul>
      </div>
      <div class="space-y-3">
        <h3 class="font-semibold text-slate-800">4.2 Procédure de replay</h3>
        <ol class="list-decimal pl-5 space-y-1">
          <li>Ouvrir <strong>/dossiers/{id}</strong> et sélectionner la carte « Scénarios d’intégration ».</li>
          <li>Choisir le scénario et les endpoints (<em>sender</em> ou <em>both</em>).</li>
          <li>Valider : <code>scenario_runner.send_scenario</code> orchestre l’envoi, journalise chaque message et retourne les ACK.</li>
          <li>Un résumé est flashé (envoyés / ignorés / erreurs) et archivé dans <code>MessageLog</code>.</li>
        </ol>
      </div>
    </div>
    <div class="border border-slate-200 rounded-xl p-4 bg-slate-50 text-xs text-slate-700">
      <p class="font-semibold text-slate-900">Points d’attention</p>
      <ul class="list-disc pl-5 space-y-1">
        <li>Les segments <code>Zxx</code> (hors Z99) sont supprimés avant émission pour respecter PAM ≥ 2.8.</li>
        <li>Des temporisations inter-messages peuvent être imposées via <code>SCENARIO_DELAY</code> (ms).</li>
        <li>En mode boucle interne, sélectionner un endpoint de rôle <em>receiver</em> pour rejouer les messages dans la base locale.</li>
      </ul>
    </div>
  </section>

  <section id="workflow" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-6">
    <h2 class="text-xl font-semibold text-slate-900">5. Pilotage du workflow patient</h2>
    <article class="space-y-3 text-sm text-slate-700">
      <h3 class="font-semibold text-slate-800">5.1 Graphe PAM</h3>
      <p>
        <strong>/workflow/venue/{id}/view</strong> expose la matrice des transitions autorisées (admission, transfert,
        permission, sortie). Chaque arc prépare un formulaire ; la validation est assurée par
        <code>app/state_transitions.py</code> et renvoie un message explicite si la transition est interdite.
      </p>
    </article>
    <article class="space-y-3 text-sm text-slate-700">
      <h3 class="font-semibold text-slate-800">5.2 Édition des entités</h3>
      <ul class="list-disc pl-5 space-y-1">
        <li><strong>Patients</strong> : gestion des identifiants PID-3, export FHIR.</li>
        <li><strong>Dossiers</strong> : UF, type d’admission, dates. Toute modification déclenche <code>emit_to_senders</code>.</li>
        <li><strong>Venues</strong> : localisation, statut, liaison avec l’UF.</li>
        <li><strong>Mouvements</strong> : type, provenance/destination, opérateur.</li>
      </ul>
      <p class="text-xs text-slate-500">Des « actions rapides » sont proposées dans chaque vue pour générer les évènements standards.</p>
    </article>
  </section>

  <section id="endpoints" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-6">
    <h2 class="text-xl font-semibold text-slate-900">6. Interopération &amp; supervision</h2>
    <div class="grid md:grid-cols-2 gap-4 text-sm text-slate-700">
      <div class="space-y-3">
        <h3 class="font-semibold text-slate-800">6.1 Configuration des systèmes</h3>
        <ul class="list-disc pl-5 space-y-1">
          <li><strong>/endpoints</strong> : création et paramétrage des systèmes (MLLP ou FHIR, rôle, authentification).</li>
          <li>MLLP : host, port, timeout, option « trace » pour journaliser les trames.</li>
          <li>FHIR : base URL, authentification (none, Basic, Bearer), assigner OID pour surcharger PID-3.</li>
          <li>Les endpoints peuvent être désactivés temporairement sans perdre la configuration.</li>
        </ul>
      </div>
      <div class="space-y-3">
        <h3 class="font-semibold text-slate-800">6.2 Journal &amp; supervision</h3>
        <ul class="list-disc pl-5 space-y-1">
          <li><strong>/messages</strong> : filtre par endpoint, période, statut, protocole.</li>
          <li><strong>/messages/{id}</strong> : détails payload, ACK, temps de réponse, endpoint.</li>
          <li><strong>/messages/send</strong> : injecter un HL7 ou un JSON FHIR pour tester un endpoint.</li>
          <li>Sondes de santé : <code>/health/live</code>, <code>/health/ready</code>.</li>
        </ul>
      </div>
    </div>
  </section>

  <section id="troubleshooting" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-6">
    <h2 class="text-xl font-semibold text-slate-900">7. Gestion des incidents</h2>
    <div class="grid md:grid-cols-2 gap-4 text-sm text-slate-700">
      <div class="space-y-3">
        <h3 class="font-semibold text-slate-800">7.1 Contrôles automatiques</h3>
        <ul class="list-disc pl-5 space-y-1">
          <li>Transitions PAM invalides : rejetées avec message clair (ex. « A12 nécessite A02 préalable »).</li>
          <li>PID sans identifiant : erreur de validation avant persistance.</li>
          <li>Z99 : création d’entités de secours (log <code>Created placeholder …</code> dans <code>transport_inbound</code>).</li>
        </ul>
      </div>
      <div class="space-y-3">
        <h3 class="font-semibold text-slate-800">7.2 Bonnes pratiques</h3>
        <ul class="list-disc pl-5 space-y-1">
          <li>Purger ou sauvegarder la base (<code>sqlite3 poc.db .dump</code>) avant une campagne intensive.</li>
          <li>Synchroniser la structure avant les scénarios PAM afin de garantir la cohérence des segments PV1.</li>
          <li>Utiliser un endpoint interne en boucle avant de pousser vers des SI partenaires.</li>
          <li>Documenter les endpoints et tokens dans un coffre sécurisé (les secrets ne sont pas chiffrés en base).</li>
        </ul>
      </div>
    </div>
    <div class="border border-amber-200 bg-amber-50 rounded-xl p-4 text-xs text-amber-900">
      <p class="font-semibold">Astuce</p>
      <p>Définir <code>SCENARIO_DELAY</code> (millisecondes) pour insérer une temporisation entre les messages d’un scénario et se rapprocher des délais terrain.</p>
    </div>
  </section>

  <section id="references" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm space-y-4">
    <h2 class="text-xl font-semibold text-slate-900">8. Références croisées</h2>
    <ul class="list-disc pl-5 space-y-1 text-sm text-slate-700">
      <li><strong>Spécification IHE PAM France 2.8</strong> : dossier <code>Doc/SpecIHEPAM_CPage</code>.</li>
      <li><strong>Mappings HL7 ↔ FHIR</strong> : <code>app/services/vocabulary_mappings.py</code>.</li>
      <li><strong>Gestion structure</strong> : <code>app/services/mfn_structure.py</code>, <code>app/services/fhir_structure.py</code>.</li>
      <li><strong>Tests automatisés</strong> : <code>tests/test_transport_inbound.py</code>, <code>tests/test_emit_identifier_overrides.py</code>.</li>
    </ul>
  </section>
</div>
{% endblock %}
