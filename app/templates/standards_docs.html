{% extends "base.html" %}

{% block content %}
<div class="mx-auto max-w-content px-4 pb-16 space-y-12">
  <section class="mt-10 overflow-hidden rounded-3xl bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white shadow-xl">
    <div class="flex flex-col gap-6 p-10 md:flex-row md:items-center md:justify-between">
      <div class="space-y-4">
        <p class="text-sm uppercase tracking-[0.24em] text-blue-200 font-semibold">Catalogue d’interopérabilité</p>
        <h1 class="text-3xl md:text-4xl font-bold leading-tight">Documentation des standards supportés</h1>
        <p class="max-w-2xl text-sm md:text-base text-blue-100">
          Cette page rassemble les profils HL7v2 et FHIR disponibles dans MedData Bridge :
          messages de tests prêts à l’emploi, modes opératoires d’injection et liens directs
          vers les outils de validation.
        </p>
      </div>
      <div class="grid gap-3 text-xs">
        <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 backdrop-blur-sm">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
          HL7v2.5 FR / IHE PAM 2.10
        </span>
        <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 backdrop-blur-sm">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18m9-9H3"/></svg>
          FHIR R4 – PIXm, PDQm, Patient Admin
        </span>
        <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 backdrop-blur-sm">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
          Modèles prêts à tester sur l’interface d’injection
        </span>
      </div>
    </div>
  </section>

  <div class="grid gap-8 md:grid-cols-12">
    <aside class="md:col-span-4 lg:col-span-3">
      <nav class="sticky top-28 space-y-3 rounded-2xl border border-slate-200 bg-white/90 p-6 shadow-sm backdrop-blur">
        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">Sections</p>
        <div class="mt-4 flex flex-col gap-2 text-sm">
          <a href="#hl7v2" class="group inline-flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-blue-50 hover:text-blue-700">
            <span class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-100 text-blue-600 text-xs font-semibold">HL7</span>
            Standards HL7v2
          </a>
          <div class="border-l border-slate-200 pl-6">
            <a href="#ihe-pam" class="block rounded-lg px-3 py-1 text-slate-500 hover:bg-slate-100 hover:text-slate-800">IHE PAM</a>
            <a href="#ihe-pix" class="block rounded-lg px-3 py-1 text-slate-500 hover:bg-slate-100 hover:text-slate-800">IHE PIX</a>
            <a href="#ihe-pdq" class="block rounded-lg px-3 py-1 text-slate-500 hover:bg-slate-100 hover:text-slate-800">IHE PDQ</a>
          </div>
          <a href="#fhir" class="group inline-flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-emerald-50 hover:text-emerald-700">
            <span class="flex h-8 w-8 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 text-xs font-semibold">FHIR</span>
            Standards FHIR
          </a>
          <div class="border-l border-slate-200 pl-6">
            <a href="#pixm" class="block rounded-lg px-3 py-1 text-slate-500 hover:bg-slate-100 hover:text-slate-800">PIXm</a>
            <a href="#pdqm" class="block rounded-lg px-3 py-1 text-slate-500 hover:bg-slate-100 hover:text-slate-800">PDQm</a>
            <a href="#patient-admin" class="block rounded-lg px-3 py-1 text-slate-500 hover:bg-slate-100 hover:text-slate-800">Patient Admin</a>
          </div>
          <a href="#injection" class="group inline-flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 transition hover:bg-violet-50 hover:text-violet-700">
            <span class="flex h-8 w-8 items-center justify-center rounded-full bg-violet-100 text-violet-600 text-xs font-semibold">IO</span>
            Interface d’injection
          </a>
        </div>
      </nav>
    </aside>

    <div class="md:col-span-8 lg:col-span-9 space-y-16">
      <section id="hl7v2" class="space-y-10">
        <header class="flex flex-col gap-3">
          <h2 class="text-2xl font-semibold text-slate-900">Standards HL7v2</h2>
          <p class="text-sm text-slate-500">
            Jeux de messages issus de la matrice IHE France PAM 2.10, prêts à être injectés via le transport HL7.
            Chaque template inclut les segments minimaux requis et peut être enrichi avant envoi.
          </p>
        </header>

        <article id="ihe-pam" class="rounded-2xl border border-blue-100 bg-blue-50/40 p-6 shadow-sm">
          <header class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-blue-500">Profil IHE</p>
              <h3 class="text-xl font-semibold text-blue-900">IHE PAM – Patient Administration Management</h3>
            </div>
            <span class="inline-flex items-center gap-2 rounded-full bg-blue-100 px-4 py-1 text-xs text-blue-700">
              HL7 v2.5 FR • PAMv2.10
            </span>
          </header>
          <div class="mt-6 grid gap-4">
            <div class="flex flex-wrap items-start justify-between gap-4 rounded-2xl border border-white/60 bg-white/70 p-4">
              <div>
                <p class="text-sm font-medium text-slate-800"><code class="rounded bg-slate-900/10 px-2 py-1 text-xs">ADT^A01</code> Admission</p>
                <p class="text-xs text-slate-500">Création d’un séjour hospitalier (entrée).</p>
              </div>
              <button type="button" data-template="ADT^A01" data-label="ADT^A01 – Admission"
                class="inline-flex items-center gap-2 rounded-full bg-blue-500 px-4 py-2 text-xs font-semibold text-white shadow hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400">
                Voir le template
              </button>
            </div>
            <div class="flex flex-wrap items-start justify-between gap-4 rounded-2xl border border-white/60 bg-white/70 p-4">
              <div>
                <p class="text-sm font-medium text-slate-800"><code class="rounded bg-slate-900/10 px-2 py-1 text-xs">ADT^A02</code> Transfert</p>
                <p class="text-xs text-slate-500">Transfert intra-établissement (chambre/service).</p>
              </div>
              <button type="button" data-template="ADT^A02" data-label="ADT^A02 – Transfert"
                class="inline-flex items-center gap-2 rounded-full bg-blue-500 px-4 py-2 text-xs font-semibold text-white shadow hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400">
                Voir le template
              </button>
            </div>
          </div>
        </article>

        <article id="ihe-pix" class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
          <header class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">Profil IHE</p>
              <h3 class="text-xl font-semibold text-slate-900">IHE PIX – Patient Identifier Cross-reference</h3>
            </div>
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-4 py-1 text-xs text-slate-600">
              HL7 v2.5 • ITI-9 / ITI-10
            </span>
          </header>
          <div class="mt-6 grid gap-4">
            <div class="flex flex-wrap items-start justify-between gap-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div>
                <p class="text-sm font-medium text-slate-800"><code class="rounded bg-slate-900/10 px-2 py-1 text-xs">QBP^Q23</code> PIX Query</p>
                <p class="text-xs text-slate-500">Recherche des identifiants corrélés via le gestionnaire PIX.</p>
              </div>
              <button type="button" data-template="QBP^Q23" data-label="QBP^Q23 – PIX Query"
                class="inline-flex items-center gap-2 rounded-full bg-slate-700 px-4 py-2 text-xs font-semibold text-white shadow hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400">
                Voir le template
              </button>
            </div>
          </div>
        </article>

        <article id="ihe-pdq" class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
          <header class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">Profil IHE</p>
              <h3 class="text-xl font-semibold text-slate-900">IHE PDQ – Patient Demographics Query</h3>
            </div>
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-4 py-1 text-xs text-slate-600">
              HL7 v2.5 • ITI-21
            </span>
          </header>
          <div class="mt-6 grid gap-4">
            <div class="flex flex-wrap items-start justify-between gap-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div>
                <p class="text-sm font-medium text-slate-800"><code class="rounded bg-slate-900/10 px-2 py-1 text-xs">QBP^Q22</code> PDQ Query</p>
                <p class="text-xs text-slate-500">Interrogation des caractéristiques démographiques d’un patient.</p>
              </div>
              <button type="button" data-template="QBP^Q22" data-label="QBP^Q22 – PDQ Query"
                class="inline-flex items-center gap-2 rounded-full bg-slate-700 px-4 py-2 text-xs font-semibold text-white shadow hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400">
                Voir le template
              </button>
            </div>
          </div>
        </article>
      </section>

      <section id="fhir" class="space-y-10">
        <header class="flex flex-col gap-3">
          <h2 class="text-2xl font-semibold text-slate-900">Standards FHIR</h2>
          <p class="text-sm text-slate-500">
            Les scénarios FHIR s’appuient sur les profils IHE PIXm & PDQm ainsi que sur l’administration patient R4.
            Les modèles suivants sont compatibles avec les points d’injection FHIR du projet.
          </p>
        </header>

        <article id="pixm" class="rounded-2xl border border-emerald-100 bg-emerald-50/40 p-6 shadow-sm">
          <header class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-emerald-600">Profil IHE</p>
              <h3 class="text-xl font-semibold text-emerald-900">PIXm – Patient Identifier Cross-reference for Mobile</h3>
            </div>
            <span class="inline-flex items-center gap-2 rounded-full bg-emerald-100 px-4 py-1 text-xs text-emerald-700">
              FHIR R4 • Operation $ihe-pix
            </span>
          </header>
          <div class="mt-6 grid gap-4">
            <div class="flex flex-wrap items-start justify-between gap-4 rounded-2xl border border-white/70 bg-white/80 p-4">
              <div>
                <p class="text-sm font-medium text-slate-800"><code class="rounded bg-slate-900/10 px-2 py-1 text-xs">$ihe-pix</code> Cross-référencement</p>
                <p class="text-xs text-slate-500">Paramètres de requête pour retrouver les identifiants liés.</p>
              </div>
              <button type="button" data-template="PIXm" data-label="PIXm – Parameters"
                class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold text-white shadow hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-400">
                Voir le template
              </button>
            </div>
          </div>
        </article>

        <article id="pdqm" class="rounded-2xl border border-emerald-100 bg-white p-6 shadow-sm">
          <header class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">Profil IHE</p>
              <h3 class="text-xl font-semibold text-slate-900">PDQm – Patient Demographics Query for Mobile</h3>
            </div>
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-4 py-1 text-xs text-slate-600">
              FHIR R4 • Searches Patient
            </span>
          </header>
          <div class="mt-6 grid gap-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs text-slate-600">
            <div class="grid gap-1 md:grid-cols-4">
              <div class="font-semibold uppercase tracking-wide text-slate-400">Paramètre</div>
              <div class="font-semibold uppercase tracking-wide text-slate-400 md:col-span-2">Description</div>
              <div class="font-semibold uppercase tracking-wide text-slate-400">Format</div>
            </div>
            <div class="grid items-center gap-1 md:grid-cols-4">
              <code class="text-slate-700">family</code>
              <div class="md:col-span-2">Nom de famille du patient.</div>
              <div>string</div>
            </div>
            <div class="grid items-center gap-1 md:grid-cols-4">
              <code class="text-slate-700">given</code>
              <div class="md:col-span-2">Prénom (peut être répété).</div>
              <div>string</div>
            </div>
            <div class="grid items-center gap-1 md:grid-cols-4">
              <code class="text-slate-700">birthdate</code>
              <div class="md:col-span-2">Date de naissance pour cibler la cohorte.</div>
              <div>YYYY-MM-DD</div>
            </div>
            <div class="grid items-center gap-1 md:grid-cols-4">
              <code class="text-slate-700">identifier</code>
              <div class="md:col-span-2">Identifiant hospitalier (« system|value »).</div>
              <div>token</div>
            </div>
          </div>
        </article>

        <article id="patient-admin" class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
          <header class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">Profil métier</p>
              <h3 class="text-xl font-semibold text-slate-900">Patient Administration – Ressources FHIR clés</h3>
            </div>
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-4 py-1 text-xs text-slate-600">
              FHIR R4 • RESTful CRUD & Search
            </span>
          </header>
          <div class="mt-6 grid gap-4">
            <div class="flex flex-wrap items-start justify-between gap-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div>
                <p class="text-sm font-medium text-slate-800"><code class="rounded bg-slate-900/10 px-2 py-1 text-xs">Patient</code> Ressource</p>
                <p class="text-xs text-slate-500">Création et mise à jour des identités patient.</p>
              </div>
              <button type="button" data-template="Patient" data-label="Patient – Ressource"
                class="inline-flex items-center gap-2 rounded-full bg-slate-700 px-4 py-2 text-xs font-semibold text-white shadow hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400">
                Voir le template
              </button>
            </div>
            <div class="flex flex-wrap items-start justify-between gap-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div>
                <p class="text-sm font-medium text-slate-800"><code class="rounded bg-slate-900/10 px-2 py-1 text-xs">Encounter</code> Ressource</p>
                <p class="text-xs text-slate-500">Gestion du séjour (admission en cours, localisation, statut).</p>
              </div>
              <button type="button" data-template="Encounter" data-label="Encounter – Ressource"
                class="inline-flex items-center gap-2 rounded-full bg-slate-700 px-4 py-2 text-xs font-semibold text-white shadow hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400">
                Voir le template
              </button>
            </div>
          </div>
        </article>
      </section>

      <section id="injection" class="rounded-2xl border border-violet-100 bg-gradient-to-br from-violet-50 via-white to-white p-6 shadow-sm">
        <header class="flex flex-col gap-3">
          <h2 class="text-2xl font-semibold text-violet-900">Interface d’injection & journalisation</h2>
          <p class="text-sm text-violet-700">
            Toutes les interactions sont centralisées : démarrez un test en un clic puis consultez les journaux
            d’exécution pour chaque protocole.
          </p>
        </header>
        <div class="mt-6 grid gap-4 md:grid-cols-2">
          <div class="rounded-2xl border border-violet-100 bg-white/80 p-5 shadow-sm">
            <p class="text-xs uppercase tracking-[0.2em] text-violet-400 font-semibold">Points d’accès</p>
            <ul class="mt-3 space-y-3 text-sm text-slate-600">
              <li class="flex items-center justify-between gap-3 rounded-xl border border-violet-100 bg-violet-50/60 px-4 py-3">
                <div>
                  <code class="rounded bg-slate-900/10 px-2 py-1 text-xs">/transport/hl7</code>
                  <p class="text-xs text-slate-500">Injection HL7v2 (MLLP ou formulaire web).</p>
                </div>
                <a href="/transport/injection" class="inline-flex items-center gap-2 rounded-full bg-violet-500 px-4 py-2 text-xs font-semibold text-white hover:bg-violet-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-400">Tester</a>
              </li>
              <li class="flex items-center justify-between gap-3 rounded-xl border border-violet-100 bg-violet-50/60 px-4 py-3">
                <div>
                  <code class="rounded bg-slate-900/10 px-2 py-1 text-xs">/ihe/pix/query</code>
                  <p class="text-xs text-slate-500">Transaction IHE ITI-9 (PIXm côté serveur).</p>
                </div>
                <a href="/transport/injection?type=PIX" class="inline-flex items-center gap-2 rounded-full bg-violet-500 px-4 py-2 text-xs font-semibold text-white hover:bg-violet-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-400">Tester</a>
              </li>
              <li class="flex items-center justify-between gap-3 rounded-xl border border-violet-100 bg-violet-50/60 px-4 py-3">
                <div>
                  <code class="rounded bg-slate-900/10 px-2 py-1 text-xs">/ihe/pdq/query</code>
                  <p class="text-xs text-slate-500">Transaction IHE ITI-21 (PDQm côté serveur).</p>
                </div>
                <a href="/transport/injection?type=PDQ" class="inline-flex items-center gap-2 rounded-full bg-violet-500 px-4 py-2 text-xs font-semibold text-white hover:bg-violet-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-400">Tester</a>
              </li>
            </ul>
          </div>
          <div class="rounded-2xl border border-violet-100 bg-white/80 p-5 shadow-sm">
            <p class="text-xs uppercase tracking-[0.2em] text-violet-400 font-semibold">Observabilité</p>
            <ul class="mt-3 space-y-3 text-sm text-slate-600">
              <li class="flex items-start gap-3 rounded-xl border border-violet-100 bg-white px-4 py-3">
                <span class="mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full bg-violet-100 text-violet-500 text-xs font-semibold">1</span>
                <div>
                  <p class="font-medium text-slate-800">Interface web des messages</p>
                  <p class="text-xs text-slate-500">Suivi des ACK/NACK via <code>/messages</code> et <code>/admin/messages</code>.</p>
                </div>
              </li>
              <li class="flex items-start gap-3 rounded-xl border border-violet-100 bg-white px-4 py-3">
                <span class="mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full bg-violet-100 text-violet-500 text-xs font-semibold">2</span>
                <div>
                  <p class="font-medium text-slate-800">Journal SQLModel</p>
                  <p class="text-xs text-slate-500">Table <code>message_log</code> pour les analyses temps-réel.</p>
                </div>
              </li>
              <li class="flex items-start gap-3 rounded-xl border border-violet-100 bg-white px-4 py-3">
                <span class="mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full bg-violet-100 text-violet-500 text-xs font-semibold">3</span>
                <div>
                  <p class="font-medium text-slate-800">Traces MLLP détaillées</p>
                  <p class="text-xs text-slate-500">Activez <code>MLLP_TRACE=1</code> pour obtenir les dumps hexadécimaux.</p>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Template preview modal -->
<div id="template-modal" class="fixed inset-0 z-40 hidden items-center justify-center" role="dialog" aria-modal="true">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" data-close-modal></div>
  <div class="relative mx-auto mt-20 w-full max-w-3xl px-4">
    <div class="overflow-hidden rounded-3xl bg-white shadow-2xl">
      <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400 font-semibold">Template</p>
          <h3 id="templateTitle" class="text-lg font-semibold text-slate-900"></h3>
        </div>
        <button type="button" class="rounded-full p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-400" data-close-modal aria-label="Fermer la fenêtre">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="px-6 py-4">
        <pre class="max-h-96 overflow-auto rounded-2xl bg-slate-900/90 p-4 text-xs text-slate-100"><code id="templateContent"></code></pre>
      </div>
      <div class="flex flex-wrap items-center justify-between gap-3 border-t border-slate-200 bg-slate-50 px-6 py-4">
        <div class="flex items-center gap-2 text-xs text-slate-500">
          <svg class="h-4 w-4 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 8h10M7 12h6M5 4h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/></svg>
          Copiez, adaptez, puis injectez le message directement depuis l’interface.
        </div>
        <div class="flex flex-wrap gap-2">
          <button type="button" id="copyTemplate" class="inline-flex items-center gap-2 rounded-full bg-slate-800 px-4 py-2 text-xs font-semibold text-white hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 16h11a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2z"/><path d="M3 19a2 2 0 0 0 2 2h11"/></svg>
            Copier
          </button>
          <a id="testLink" href="#" class="inline-flex items-center gap-2 rounded-full bg-blue-500 px-4 py-2 text-xs font-semibold text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400">
            Tester l’injection
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const templates = {
  "ADT^A01": `MSH|^~\\&|SENDING_APP|SENDING_FAC|RECEIVING_APP|RECEIVING_FAC|20251101000000||ADT^A01|MSG00001|P|2.5
EVN|A01|20251101000000|||APPLI^IHE
PID|||123456^^^HOPITAL||DUPONT^JEAN||19800101|M
PV1||I|CARDIO^101^1|||||||||||||||||1|||||||||||||||||||||||||20251101000000`,

  "ADT^A02": `MSH|^~\\&|SENDING_APP|SENDING_FAC|RECEIVING_APP|RECEIVING_FAC|20251101000000||ADT^A02|MSG00002|P|2.5
EVN|A02|20251101000000|||APPLI^IHE
PID|||123456^^^HOPITAL||DUPONT^JEAN||19800101|M
PV1||I|CARDIO^101^1|||||||||||||||||1|||||||||||||||||||||||||20251101000000|20251101120000`,

  "QBP^Q23": `MSH|^~\\&|SENDING_APP|SENDING_FAC|PIX_MGR|PIX_FAC|20251101000000||QBP^Q23^QBP_Q21|MSG00001|P|2.5
QPD|IHE PIX Query|QRY123|123456^^^HOPITAL
RCP|I`,

  "QBP^Q22": `MSH|^~\\&|SENDING_APP|SENDING_FAC|PDQ_MGR|PDQ_FAC|20251101000000||QBP^Q22^QBP_Q21|MSG00001|P|2.5
QPD|IHE PDQ Query|QRY123|@PID.5.1^DUPONT~@PID.5.2^JEAN~@PID.7^19800101
RCP|I`,

  "PIXm": {
    "resourceType": "Parameters",
    "parameter": [{
      "name": "sourceIdentifier",
      "valueIdentifier": {
        "system": "http://hopital-a.fr/id",
        "value": "123456"
      }
    }]
  },

  "Patient": {
    "resourceType": "Patient",
    "identifier": [{
      "system": "http://hopital.fr/id",
      "value": "123456"
    }],
    "name": [{
      "family": "DUPONT",
      "given": ["Jean"]
    }],
    "birthDate": "1980-01-01",
    "gender": "male"
  },

  "Encounter": {
    "resourceType": "Encounter",
    "status": "in-progress",
    "class": {
      "system": "http://terminology.hl7.org/CodeSystem/v3-ActCode",
      "code": "IMP",
      "display": "inpatient encounter"
    },
    "subject": {
      "reference": "Patient/123"
    },
    "period": {
      "start": "2025-11-01T00:00:00+01:00"
    },
    "location": [{
      "location": {
        "reference": "Location/CARDIO-101"
      }
    }]
  }
};

const modal = document.getElementById("template-modal");
const titleEl = document.getElementById("templateTitle");
const contentEl = document.getElementById("templateContent");
const testLink = document.getElementById("testLink");
const copyBtn = document.getElementById("copyTemplate");

function determineEndpoint(type) {
  if (type.startsWith("ADT^") || type.startsWith("QBP^")) {
    return "/transport/injection";
  }
  if (type === "PIXm") {
    return "/transport/injection?type=PIX";
  }
  return "/transport/injection?type=FHIR";
}

function openTemplate(type, label) {
  const template = templates[type];
  if (!template) {
    contentEl.textContent = "// Template introuvable";
  } else if (typeof template === "string") {
    contentEl.textContent = template;
  } else {
    contentEl.textContent = JSON.stringify(template, null, 2);
  }
  titleEl.textContent = label;
  testLink.href = determineEndpoint(type);
  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

function closeModal() {
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

document.querySelectorAll("[data-template]").forEach((button) => {
  button.addEventListener("click", () => {
    const type = button.dataset.template;
    const label = button.dataset.label || type;
    openTemplate(type, label);
  });
});

document.querySelectorAll("[data-close-modal]").forEach((button) => {
  button.addEventListener("click", closeModal);
});

copyBtn.addEventListener("click", () => {
  const text = contentEl.textContent || "";
  navigator.clipboard.writeText(text).then(() => {
    copyBtn.classList.add("bg-green-600");
    copyBtn.textContent = "Copié !";
    setTimeout(() => {
      copyBtn.classList.remove("bg-green-600");
      copyBtn.textContent = "Copier";
    }, 1600);
  });
});

document.addEventListener("keydown", (event) => {
  if (event.key === "Escape" && !modal.classList.contains("hidden")) {
    closeModal();
  }
});
</script>
{% endblock %}
