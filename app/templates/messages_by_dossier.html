{% extends "base.html" %}
{% from "macros/doc_link.html" import doc_link %}

{% block content %}
<!-- Lien vers la documentation -->
<div class="mb-4 flex justify-end">
  {{ doc_link(request.url.path) }}
</div>

<div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-6">
  <div>
    <h2 class="text-xl font-semibold text-slate-800">Vue par dossier</h2>
    <p class="text-sm text-slate-500">Messages groupés par numéro de dossier avec statut global</p>
  </div>
  <div class="flex flex-wrap gap-2 text-xs">
    <a href="/messages" class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1.5 text-slate-600 hover:bg-slate-200 transition">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
      Vue chronologique
    </a>
    <a href="/messages/rejections" class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1.5 text-slate-600 hover:bg-slate-200 transition">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
      Rejets
    </a>
  </div>
</div>

<!-- Filtres -->
<form method="get" action="/messages/by-dossier" class="bg-white rounded-2xl border border-slate-200 p-6 mb-6 shadow-sm" data-no-ajax="true">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <label class="block">
      <span class="text-sm text-slate-600">Endpoint</span>
      <select name="endpoint_id" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
        <option value="">Tous</option>
        {% for e in endpoints %}
          <option value="{{ e.id }}" {% if filters.endpoint_id|string == e.id|string %}selected{% endif %}>{{ e.name }}</option>
        {% endfor %}
      </select>
    </label>

    <label class="block">
      <span class="text-sm text-slate-600">Direction</span>
      <select name="direction" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
        <option value="">Toutes</option>
        <option value="in" {% if filters.direction == 'in' %}selected{% endif %}>Entrante (in)</option>
        <option value="out" {% if filters.direction == 'out' %}selected{% endif %}>Sortante (out)</option>
      </select>
    </label>

    <label class="block">
      <span class="text-sm text-slate-600">Limite</span>
      <input type="number" name="limit" min="1" max="10000" value="{{ filters.limit }}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
    </label>

    <label class="block">
      <span class="text-sm text-slate-600">Début</span>
      <input type="datetime-local" name="date_start" value="{{ filters.date_start }}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
    </label>

    <label class="block">
      <span class="text-sm text-slate-600">Fin</span>
      <input type="datetime-local" name="date_end" value="{{ filters.date_end }}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
    </label>
  </div>

  <div class="mt-5 flex flex-wrap gap-2">
    <button type="submit" class="btn btn-primary inline-flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4z"/></svg>
      Appliquer les filtres
    </button>
    <a href="/messages/by-dossier" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 transition">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M3 12h10m-10 6h18"/></svg>
      Réinitialiser
    </a>
  </div>
</form>

<!-- Statistiques rapides -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  {% set total_dossiers = dossiers|length %}
  {% set dossiers_ok = dossiers|selectattr('global_status', 'equalto', 'ok')|list|length %}
  {% set dossiers_warning = dossiers|selectattr('global_status', 'equalto', 'warning')|list|length %}
  {% set dossiers_error = dossiers|selectattr('global_status', 'equalto', 'error')|list|length %}
  
  <div class="bg-white rounded-lg border border-slate-200 p-4">
    <div class="text-sm text-slate-600 mb-1">Total dossiers</div>
    <div class="text-2xl font-bold text-slate-900">{{ total_dossiers }}</div>
  </div>
  
  <div class="bg-green-50 rounded-lg border border-green-200 p-4">
    <div class="text-sm text-green-700 mb-1">Dossiers OK</div>
    <div class="text-2xl font-bold text-green-900">{{ dossiers_ok }}</div>
  </div>
  
  <div class="bg-orange-50 rounded-lg border border-orange-200 p-4">
    <div class="text-sm text-orange-700 mb-1">Avec warnings</div>
    <div class="text-2xl font-bold text-orange-900">{{ dossiers_warning }}</div>
  </div>
  
  <div class="bg-red-50 rounded-lg border border-red-200 p-4">
    <div class="text-sm text-red-700 mb-1">Avec erreurs</div>
    <div class="text-2xl font-bold text-red-900">{{ dossiers_error }}</div>
  </div>
</div>

<!-- Tableau des dossiers -->
<div class="overflow-x-auto bg-white rounded-2xl border border-slate-200 shadow-sm">
  <table class="min-w-full text-sm leading-relaxed">
    <thead class="bg-slate-50">
      <tr>
        <th class="text-left font-semibold text-slate-500 px-4 py-3 uppercase text-xs tracking-wide">Statut</th>
        <th class="text-left font-semibold text-slate-500 px-4 py-3 uppercase text-xs tracking-wide">Dossier</th>
        <th class="text-left font-semibold text-slate-500 px-4 py-3 uppercase text-xs tracking-wide">IPP</th>
        <th class="text-left font-semibold text-slate-500 px-4 py-3 uppercase text-xs tracking-wide">Messages</th>
        <th class="text-left font-semibold text-slate-500 px-4 py-3 uppercase text-xs tracking-wide">Types</th>
        <th class="text-left font-semibold text-slate-500 px-4 py-3 uppercase text-xs tracking-wide">Dernière activité</th>
        <th class="text-left font-semibold text-slate-500 px-4 py-3 uppercase text-xs tracking-wide">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if dossiers|length == 0 %}
      <tr>
        <td colspan="7" class="px-4 py-6 text-center text-slate-500">Aucun dossier pour ces filtres.</td>
      </tr>
      {% else %}
      {% for d in dossiers %}
      <tr class="border-t border-slate-100 hover:bg-blue-50/40 transition">
        <!-- Statut -->
        <td class="px-4 py-3">
          {% if d.global_status == 'ok' %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
              OK
            </span>
          {% elif d.global_status == 'warning' %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a1 1 0 00.86 1.5h18.64a1 1 0 00.86-1.5L13.71 3.86a1 1 0 00-1.72 0z"></path></svg>
              Warning
            </span>
          {% else %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              Erreur
            </span>
          {% endif %}
        </td>
        
        <!-- Numéro de dossier -->
        <td class="px-4 py-3">
          <span class="font-mono text-slate-900 font-medium">{{ d.dossier_number }}</span>
        </td>
        
        <!-- IPP -->
        <td class="px-4 py-3">
          <span class="font-mono text-xs text-slate-600">{{ d.ipp if d.ipp else '-' }}</span>
        </td>
        
        <!-- Nombre de messages -->
        <td class="px-4 py-3">
          <div class="flex flex-col text-xs">
            <span class="font-medium text-slate-900">{{ d.message_count }} message{% if d.message_count > 1 %}s{% endif %}</span>
            <div class="flex gap-2 mt-1">
              {% if d.success_count > 0 %}
                <span class="text-green-600">{{ d.success_count }} OK</span>
              {% endif %}
              {% if d.warning_count > 0 %}
                <span class="text-orange-600">{{ d.warning_count }} warn</span>
              {% endif %}
              {% if d.error_count > 0 %}
                <span class="text-red-600">{{ d.error_count }} err</span>
              {% endif %}
            </div>
          </div>
        </td>
        
        <!-- Types de messages -->
        <td class="px-4 py-3">
          {% set tooltip_parts = [] %}
          {% for msg_type in d.message_types %}
            {% if msg_type in d.message_types_with_errors %}
              {% set _ = tooltip_parts.append(msg_type ~ ' ⚠️ (erreur)') %}
            {% else %}
              {% set _ = tooltip_parts.append(msg_type) %}
            {% endif %}
          {% endfor %}
          <div class="flex flex-wrap gap-1" 
               title="{{ tooltip_parts|join(', ') if tooltip_parts else '-' }}"
               style="cursor: help;">
            {% for msg_type in d.message_types[:3] %}
              {% if msg_type in d.message_types_with_errors %}
                <span class="inline-block px-2 py-0.5 rounded text-xs bg-red-100 text-red-800 font-mono border border-red-300 font-semibold">{{ msg_type }}</span>
              {% else %}
                <span class="inline-block px-2 py-0.5 rounded text-xs bg-slate-100 text-slate-700 font-mono">{{ msg_type }}</span>
              {% endif %}
            {% endfor %}
            {% if d.message_types|length > 3 %}
              <span class="inline-block px-2 py-0.5 rounded text-xs bg-slate-200 text-slate-600 font-medium">+{{ d.message_types|length - 3 }}</span>
            {% endif %}
          </div>
        </td>
        
        <!-- Dernière activité -->
        <td class="px-4 py-3 text-xs text-slate-600">
          {{ d.last_activity.strftime('%d/%m/%Y %H:%M') if d.last_activity else '-' }}
        </td>
        
        <!-- Actions -->
        <td class="px-4 py-3">
          <div class="flex gap-2">
            <a href="/messages/validate-dossier?dossier_number={{ d.dossier_number }}" 
               class="inline-flex items-center gap-1 px-2 py-1 text-xs text-purple-600 hover:bg-purple-50 rounded transition"
               title="Valider le workflow"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
              Valider
            </a>
            <a href="/messages/dossier/{{ d.dossier_number }}/detail" 
               class="inline-flex items-center gap-1 px-2 py-1 text-xs text-blue-600 hover:bg-blue-50 rounded transition"
               title="Voir tous les messages du dossier"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
              Détails
            </a>
            <a href="/messages/dossier/{{ d.dossier_number }}/export" 
               class="inline-flex items-center gap-1 px-2 py-1 text-xs text-green-600 hover:bg-green-50 rounded transition"
               title="Exporter tous les messages en ZIP"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
              Export
            </a>
          </div>
        </td>
      </tr>
      {% endfor %}
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Information sur les types d'erreurs détectés -->
{% if dossiers_error > 0 %}
<div class="mt-6 bg-red-50 border-l-4 border-red-400 p-4">
  <div class="flex">
    <div class="flex-shrink-0">
      <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
      </svg>
    </div>
    <div class="ml-3">
      <p class="text-sm text-red-700">
        <strong>{{ dossiers_error }} dossier{% if dossiers_error > 1 %}s{% endif %} avec des erreurs détectées.</strong>
        Utilisez le bouton "Valider" pour analyser en détail le workflow de chaque dossier.
      </p>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
