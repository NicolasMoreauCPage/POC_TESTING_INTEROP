{% extends "base.html" %}
{% block content %}
<h2 class="text-lg font-semibold mb-4">Patient #{{ patient.id }}</h2>
<div class="bg-white rounded-xl border border-slate-200 p-6 max-w-2xl">
  <dl class="grid grid-cols-2 gap-x-4 gap-y-2">
    <dt class="text-slate-500">Numéro séquence</dt><dd class="font-medium">{{ patient.patient_seq }}</dd>
  <dt class="text-slate-500">External ID</dt><dd>{{ patient.external_id|none_to_dash }}</dd>
    
    <dt class="text-slate-500 col-span-2 font-semibold mt-2 border-t pt-2">Identité</dt>
  <dt class="text-slate-500">Civilité</dt><dd>{{ patient.prefix|none_to_dash }}</dd>
    <dt class="text-slate-500">Nom</dt><dd class="font-medium">{{ patient.family }}</dd>
  <dt class="text-slate-500">Nom de naissance</dt><dd>{{ patient.birth_family|none_to_dash }}</dd>
    <dt class="text-slate-500">Prénom</dt><dd class="font-medium">{{ patient.given }}</dd>
  <dt class="text-slate-500">Deuxième prénom</dt><dd>{{ patient.middle|none_to_dash }}</dd>
  <dt class="text-slate-500">Suffixe</dt><dd>{{ patient.suffix|none_to_dash }}</dd>
  <dt class="text-slate-500">Date de naissance</dt><dd>{{ patient.birth_date|none_to_dash }}</dd>
  <dt class="text-slate-500">Sexe administratif</dt><dd>{{ patient.gender|none_to_dash }}</dd>
    
    <dt class="text-slate-500 col-span-2 font-semibold mt-2 border-t pt-2">Coordonnées (domicile)</dt>
  <dt class="text-slate-500">Adresse</dt><dd>{{ patient.address|none_to_dash }}</dd>
  <dt class="text-slate-500">Ville</dt><dd>{{ patient.city|none_to_dash }}</dd>
  <dt class="text-slate-500">Code postal</dt><dd>{{ patient.postal_code|none_to_dash }}</dd>
  <dt class="text-slate-500">Département/Région</dt><dd>{{ patient.state|none_to_dash }}</dd>
  <dt class="text-slate-500">Pays</dt><dd>{{ patient.country|none_to_dash }}</dd>
  <dt class="text-slate-500">Téléphone fixe</dt><dd>{{ patient.phone|none_to_dash }}</dd>
  <dt class="text-slate-500">Téléphone mobile</dt><dd>{{ patient.mobile|none_to_dash }}</dd>
  <dt class="text-slate-500">Téléphone pro</dt><dd>{{ patient.work_phone|none_to_dash }}</dd>
  <dt class="text-slate-500">Email</dt><dd>{{ patient.email|none_to_dash }}</dd>
    
    <dt class="text-slate-500 col-span-2 font-semibold mt-2 border-t pt-2">Lieu de naissance</dt>
  <dt class="text-slate-500">Adresse de naissance</dt><dd>{{ patient.birth_address|none_to_dash }}</dd>
  <dt class="text-slate-500">Ville de naissance</dt><dd>{{ patient.birth_city|none_to_dash }}</dd>
  <dt class="text-slate-500">Département/Région</dt><dd>{{ patient.birth_state|none_to_dash }}</dd>
  <dt class="text-slate-500">Code postal</dt><dd>{{ patient.birth_postal_code|none_to_dash }}</dd>
  <dt class="text-slate-500">Pays de naissance</dt><dd>{{ patient.birth_country|none_to_dash }}</dd>
    
    <dt class="text-slate-500 col-span-2 font-semibold mt-2 border-t pt-2">Informations administratives</dt>
  <dt class="text-slate-500">NIR (Sécurité sociale)</dt><dd>{{ patient.nir|none_to_dash }}</dd>
  <dt class="text-slate-500">Statut marital</dt><dd>{{ patient.marital_status|none_to_dash }}</dd>
  <dt class="text-slate-500">Nationalité</dt><dd>{{ patient.nationality|none_to_dash }}</dd>
    <dt class="text-slate-500">Fiabilité identité (PID-32)</dt><dd>
      {% if patient.identity_reliability_code %}
        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium 
          {% if patient.identity_reliability_code == 'VIDE' %}bg-green-100 text-green-800
          {% elif patient.identity_reliability_code == 'VALI' %}bg-blue-100 text-blue-800
          {% elif patient.identity_reliability_code == 'PROV' %}bg-yellow-100 text-yellow-800
          {% elif patient.identity_reliability_code == 'DOUTE' %}bg-orange-100 text-orange-800
          {% elif patient.identity_reliability_code == 'FICTI' %}bg-gray-100 text-gray-800
          {% endif %}">
          {{ patient.identity_reliability_code }}
        </span>
      {% else %}
        —
      {% endif %}
    </dd>
  <dt class="text-slate-500">Nom de jeune fille (mère)</dt><dd>{{ patient.mothers_maiden_name|none_to_dash }}</dd>
  <dt class="text-slate-500">Médecin traitant</dt><dd>{{ patient.primary_care_provider|none_to_dash }}</dd>
  </dl>
  
  <div class="mt-6 flex gap-3">
    <a href="/patients/{{ patient.id }}/edit" class="btn btn-primary">Modifier</a>
    <form method="post" action="/patients/{{ patient.id }}/delete" onsubmit="return confirm('⚠️ Confirmer la suppression de ce patient ?\n\nCette action supprimera également tous les dossiers, venues et mouvements associés.');" style="display:inline;">
      <button type="submit" class="btn btn-danger">Supprimer</button>
    </form>
    <a href="/patients" class="btn btn-secondary">Retour à la liste</a>
  </div>
</div>


<div class="mt-10 max-w-4xl">
  <h3 class="text-lg font-semibold mb-2">Dossiers du patient</h3>
  {% if dossiers and dossiers|length > 0 %}
    <div class="space-y-6">
      {% for dossier in dossiers %}
        <div class="border rounded-lg bg-white p-4 shadow-sm hover:shadow-md transition">
          <div class="flex items-center justify-between mb-2">
            <a href="/dossiers/{{ dossier.id }}" class="font-semibold text-blue-700 hover:text-blue-900 hover:underline">
              Dossier #{{ dossier.dossier_seq }} ({{ dossier.dossier_type }})
            </a>
            <div class="flex gap-2">
              <a href="/dossiers/{{ dossier.id }}/edit" class="inline-flex items-center gap-1 px-2 py-1 text-xs text-blue-600 hover:text-blue-800 border border-blue-200 rounded hover:bg-blue-50 transition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                Modifier
              </a>
              <a href="/dossiers/{{ dossier.id }}" class="inline-flex items-center gap-1 px-2 py-1 text-xs text-slate-600 hover:text-slate-800 border border-slate-200 rounded hover:bg-slate-50 transition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                Voir
              </a>
            </div>
          </div>
          <div class="text-sm text-slate-600 mb-2">Admis le {{ dossier.admit_time }} {% if dossier.discharge_time %}— Sorti le {{ dossier.discharge_time }}{% endif %}</div>
          <div class="ml-4">
            <h4 class="font-medium text-slate-700 mt-2">Venues</h4>
            {% if dossier.venues and dossier.venues|length > 0 %}
              <ul class="list-none ml-0 space-y-3">
                {% for venue in dossier.venues %}
                  <li class="border-l-2 border-emerald-300 pl-3 py-2">
                    <div class="flex items-center justify-between mb-1">
                      <a href="/venues/{{ venue.id }}" class="font-semibold text-emerald-700 hover:text-emerald-900 hover:underline">
                        Venue #{{ venue.venue_seq }} ({{ venue.label or venue.code or '—' }})
                      </a>
                      <div class="flex gap-2">
                        <a href="/venues/{{ venue.id }}/edit" class="inline-flex items-center gap-1 px-2 py-1 text-xs text-emerald-600 hover:text-emerald-800 border border-emerald-200 rounded hover:bg-emerald-50 transition">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                          Modifier
                        </a>
                        <a href="/workflow/venue/{{ venue.id }}/view" class="inline-flex items-center gap-1 px-2 py-1 text-xs text-purple-600 hover:text-purple-800 border border-purple-200 rounded hover:bg-purple-50 transition">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                          Workflow
                        </a>
                        <a href="/venues/{{ venue.id }}" class="inline-flex items-center gap-1 px-2 py-1 text-xs text-slate-600 hover:text-slate-800 border border-slate-200 rounded hover:bg-slate-50 transition">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                          Voir
                        </a>
                      </div>
                    </div>
                    <div class="text-xs text-slate-500">Début : {{ venue.start_time }}</div>
                    <div class="ml-0 mt-2">
                      <span class="font-medium text-slate-700 text-sm">Mouvements :</span>
                      {% if venue.mouvements and venue.mouvements|length > 0 %}
                        <table class="mt-2 text-xs border border-slate-200 w-full rounded overflow-hidden">
                          <thead>
                            <tr class="bg-slate-100">
                              <th class="px-2 py-1 text-left">#</th>
                              <th class="px-2 py-1 text-left">Type</th>
                              <th class="px-2 py-1 text-left">Date/Heure</th>
                              <th class="px-2 py-1 text-left">Lieu</th>
                              <th class="px-2 py-1 text-left">Note</th>
                              <th class="px-2 py-1 text-left">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for m in venue.mouvements %}
                              <tr class="hover:bg-slate-50 transition">
                                <td class="px-2 py-1">
                                  <a href="/mouvements/{{ m.id }}" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">
                                    {{ m.mouvement_seq }}
                                  </a>
                                </td>
                                <td class="px-2 py-1">{{ m.movement_type|none_to_dash }}</td>
                                <td class="px-2 py-1">{{ m.when }}</td>
                                <td class="px-2 py-1">{{ m.location|none_to_dash }}</td>
                                <td class="px-2 py-1">{{ m.note|none_to_dash }}</td>
                                <td class="px-2 py-1">
                                  <a href="/mouvements/{{ m.id }}/edit" class="text-blue-600 hover:text-blue-800 hover:underline">
                                    Modifier
                                  </a>
                                </td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <div class="text-slate-400 italic text-xs mt-1">Aucun mouvement</div>
                      {% endif %}
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-slate-400 italic">Aucune venue</div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-slate-400 italic">Aucun dossier pour ce patient.</div>
  {% endif %}
</div>

<!-- Note RGPD -->
<div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800 max-w-2xl">
  <strong>ℹ️ Conformité RGPD France :</strong> Les données sensibles (race, religion) ne sont pas collectées conformément à la réglementation française.
</div>
{% endblock %}
