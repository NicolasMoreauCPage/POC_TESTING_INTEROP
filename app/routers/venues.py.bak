from fastapi import APIRouter, Depends, Request, Form, Query
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.templating import Jinja2Templates
from sqlmodel import select
from datetime import datetime
from app.db import get_session, get_next_sequence, peek_next_sequence
from app.models import Venue, Dossier
from app.services.emit_on_create import emit_to_senders
from app.dependencies.ght import require_ght_context

templates = Jinja2Templates(directory="app/templates")
router = APIRouter(
    prefix="/venues",
    tags=["venues"],
    dependencies=[Depends(require_ght_context)],
)

@router.get("", response_class=HTMLResponse)
def list_venues(
    request: Request, 
    dossier_id: int = Query(..., description="ID du dossier dont on veut voir les venues"), 
    session=Depends(get_session)
):
    # Vérifier que le dossier existe
    dossier = session.get(Dossier, dossier_id)
    if not dossier:
        return templates.TemplateResponse(
            request, 
            "error.html",
            {
                "request": request,
                "title": "Dossier introuvable",
                "message": "Le dossier spécifié n'existe pas. Veuillez sélectionner un dossier valide.",
                "back_url": "/dossiers"
            },
            status_code=404
        )
    
    # Rafraîchir le dossier avec le patient pour le fil d'Ariane
    session.refresh(dossier, ['patient'])
    
    # Construction de la requête filtrée par dossier
    stmt = select(Venue).where(Venue.dossier_id == dossier_id)

    # Exécuter la requête
    venues = session.exec(stmt).all()

    # Préparer les lignes avec les actions détaillées
    rows = [
        {
            "cells": [
                v.venue_seq, 
                v.id, 
                v.dossier_id, 
                v.uf_responsabilite, 
                getattr(v,'hospital_service',None), 
                v.start_time.strftime("%d/%m/%Y %H:%M") if v.start_time else None,
                v.code,
                v.label
            ],
            "detail_url": f"/venues/{v.id}",
            "edit_url": f"/venues/{v.id}/edit",
            "delete_url": f"/venues/{v.id}/delete"
        } 
        for v in venues
    ]

    # Construire le fil d'Ariane
    breadcrumbs = [{"label": "Venues", "url": "/venues"}]
    if dossier_id and dossier:
        breadcrumbs.insert(0, {"label": f"Dossier #{dossier.dossier_seq}", "url": f"/dossiers/{dossier_id}"})
        if dossier.patient:
            breadcrumbs.insert(0, {
                "label": f"Patient: {dossier.patient.family} {dossier.patient.given}", 
                "url": f"/patients/{dossier.patient.id}"
            })

    # Définir les filtres de recherche
    filters = [
        {
            "label": "UF responsabilité",
            "name": "uf",
            "type": "text",
            "placeholder": "Filtrer par UF"
        },
        {
            "label": "Service",
            "name": "service",
            "type": "select",
            "placeholder": "Tous les services",
            "options": [
                {"value": "cardiology", "label": "Cardiologie"},
                {"value": "neurology", "label": "Neurologie"},
                {"value": "oncology", "label": "Oncologie"},
                {"value": "pediatrics", "label": "Pédiatrie"},
                {"value": "other", "label": "Autre"}
            ]
        },
        {
            "label": "Local",
            "name": "location",
            "type": "text",
            "placeholder": "Filtrer par local"
        }
    ]

    # Définir les actions disponibles
    actions = [
        {
            "type": "link",
            "label": "Export FHIR",
            "url": "/venues/export/fhir"
        },
        {
            "type": "link",
            "label": "Export HL7",
            "url": "/venues/export/hl7"
        }
    ]

    # Construire le contexte complet
    ctx = {
        "request": request,
        "title": "Venues" if not dossier_id else f"Venues du dossier #{dossier.dossier_seq}",
        "breadcrumbs": breadcrumbs,
        "headers": ["Seq", "ID", "Dossier", "UF Resp", "Service", "Début", "Code", "Libellé"],
        "rows": rows,
        "context": {"dossier_id": dossier_id},
        "new_url": f"/venues/new?dossier_id={dossier_id}",
        "filters": filters,
        "actions": actions,
        "show_actions": True
    }

    return templates.TemplateResponse(request, "list.html", ctx)

@router.get("/{venue_id}", response_class=HTMLResponse)
def venue_detail(venue_id: int, request: Request, session=Depends(get_session)):
    v = session.get(Venue, venue_id)
    if not v:
        return templates.TemplateResponse(request, "not_found.html", {"request": request, "title": "Venue introuvable"}, status_code=404)
    return templates.TemplateResponse(request, "venue_detail.html", {"request": request, "venue": v})


@router.get("/{venue_id}/edit", response_class=HTMLResponse)
def edit_venue(venue_id: int, request: Request, session=Depends(get_session)):
    v = session.get(Venue, venue_id)
    if not v:
            return templates.TemplateResponse(request, "not_found.html", {"request": request, "title": "Venue introuvable"}, status_code=404)
    fields = [
        {"label": "Dossier ID", "name": "dossier_id", "type": "number", "value": v.dossier_id, "required": True,
         "help": "ID du dossier existant dans la base"},
        {"label": "UF de responsabilité", "name": "uf_responsabilite", "type": "text", "value": v.uf_responsabilite, "required": True,
         "help": "Unité fonctionnelle responsable de la venue"},
        {"label": "Début de venue", "name": "start_time", "type": "datetime-local", 
         "value": v.start_time.strftime('%Y-%m-%dT%H:%M') if v.start_time else '', "required": True,
         "help": "Date et heure de début de la venue"},
        {"label": "Service hospitalier", "name": "hospital_service", "type": "select", 
         "options": ["cardiology", "neurology", "oncology", "pediatrics", "other"], 
         "value": getattr(v,'hospital_service',None),
         "help": "Service médical responsable"},
        {"label": "Local assigné", "name": "assigned_location", "type": "text", 
         "value": getattr(v,'assigned_location',None),
         "help": "Localisation physique du patient"},
        {"label": "Médecin responsable", "name": "attending_provider", "type": "text", 
         "value": getattr(v,'attending_provider',None),
         "help": "Médecin responsable de la venue"},
        {"label": "Lit", "name": "bed", "type": "text", 
         "value": getattr(v,'bed',None),
         "help": "Numéro ou identifiant du lit"},
        {"label": "Chambre", "name": "room", "type": "text", 
         "value": getattr(v,'room',None),
         "help": "Numéro ou identifiant de la chambre"},
        {"label": "Code", "name": "code", "type": "text", 
         "value": v.code,
         "help": "Code optionnel de la venue"},
        {"label": "Libellé", "name": "label", "type": "text", 
         "value": v.label,
         "help": "Description libre de la venue"},
        {"label": "Numéro de séquence", "name": "venue_seq", "type": "number", 
         "value": v.venue_seq,
         "help": "Numéro de séquence unique de la venue"},
        {"label": "Département gestionnaire", "name": "managing_department", "type": "text", "value": getattr(v, "managing_department", None)},
        {"label": "Type physique", "name": "physical_type", "type": "text", "value": getattr(v, "physical_type", None)},
        {"label": "Statut opérationnel", "name": "operational_status", "type": "text", "value": getattr(v, "operational_status", None)},
    ]
    return templates.TemplateResponse(request, "form.html", {"request": request, "title": "Modifier venue", "fields": fields, "action_url": f"/venues/{venue_id}/edit"})


@router.post("/{venue_id}/edit")
def update_venue(
    venue_id: int,
    dossier_id: int = Form(...),
    uf_responsabilite: str = Form(...),
    start_time: str = Form(...),
    hospital_service: str = Form(None),
    assigned_location: str = Form(None),
    attending_provider: str = Form(None),
    bed: str = Form(None),
    room: str = Form(None),
    code: str = Form(None),
    label: str = Form(None),
    venue_seq: int = Form(...),
    managing_department: str = Form(None),
    physical_type: str = Form(None),
    operational_status: str = Form(None),
    session=Depends(get_session),
    request: Request = None
):
    v = session.get(Venue, venue_id)
    if not v:
        return templates.TemplateResponse(request, "not_found.html", {"request": request, "title": "Venue introuvable"}, status_code=404)
    v.dossier_id = dossier_id
    v.uf_responsabilite = uf_responsabilite
    v.start_time = datetime.fromisoformat(start_time)
    v.hospital_service = hospital_service
    v.assigned_location = assigned_location
    v.attending_provider = attending_provider
    v.bed = bed
    v.room = room
    v.code = code
    v.label = label
    v.venue_seq = venue_seq
    v.managing_department = managing_department
    v.physical_type = physical_type
    v.operational_status = operational_status
    session.add(v); session.commit()
    emit_to_senders(v, "venue", session)
    return RedirectResponse(url="/venues", status_code=303)


@router.post("/{venue_id}/delete")
def delete_venue(venue_id: int, request: Request, session=Depends(get_session)):
    v = session.get(Venue, venue_id)
    if not v:
        return templates.TemplateResponse(request, "not_found.html", {"request": request, "title": "Venue introuvable"}, status_code=404)
    dossier_id = v.dossier_id  # Capture l'ID du dossier avant de supprimer
    session.delete(v); session.commit()
    emit_to_senders(v, "venue", session)
    return RedirectResponse(url=f"/venues?dossier_id={dossier_id}", status_code=303)

@router.get("/new", response_class=HTMLResponse)
def new_venue(
    request: Request, 
    dossier_id: int | None = Query(None, description="ID du dossier parent (pré-rempli si fourni)"),
    session=Depends(get_session)
):
    next_seq = peek_next_sequence(session, "venue")
    now_str = datetime.now().strftime("%Y-%m-%dT%H:%M")
    
    # Si dossier_id fourni en query param, pré-remplir le champ
    # Sinon, tenter de récupérer depuis le contexte
    prefill_dossier_id = dossier_id
    if prefill_dossier_id is None and hasattr(request.state, 'dossier_context') and request.state.dossier_context:
        prefill_dossier_id = request.state.dossier_context.id
    
    fields = [
        {"label": "Dossier ID", "name": "dossier_id", "type": "number", "required": True,
         "value": prefill_dossier_id or '',
         "help": "ID du dossier existant dans la base"},
        {"label": "UF de responsabilité", "name": "uf_responsabilite", "type": "text", "required": True,
         "help": "Unité fonctionnelle responsable de la venue"},
        {"label": "Début de venue", "name": "start_time", "type": "datetime-local", 
         "value": now_str, "required": True,
         "help": "Date et heure de début de la venue"},
        {"label": "Service hospitalier", "name": "hospital_service", "type": "select",
         "options": ["cardiology", "neurology", "oncology", "pediatrics", "other"],
         "help": "Service médical responsable"},
        {"label": "Local assigné", "name": "assigned_location", "type": "text",
         "help": "Localisation physique du patient"},
        {"label": "Médecin responsable", "name": "attending_provider", "type": "text",
         "help": "Médecin responsable de la venue"},
        {"label": "Lit", "name": "bed", "type": "text",
         "help": "Numéro ou identifiant du lit"},
        {"label": "Chambre", "name": "room", "type": "text",
         "help": "Numéro ou identifiant de la chambre"},
        {"label": "Code", "name": "code", "type": "text",
         "help": "Code optionnel de la venue"},
        {"label": "Libellé", "name": "label", "type": "text",
         "help": "Description libre de la venue"},
        {"label": "Numéro de séquence", "name": "venue_seq", "type": "number", 
         "value": next_seq,
         "help": "Généré automatiquement si non renseigné"},
        {"label": "Département gestionnaire", "name": "managing_department", "type": "text",
         "help": "Département administratif responsable"},
        {"label": "Type physique", "name": "physical_type", "type": "text",
         "help": "Nature du lieu physique (chambre, box, etc.)"},
        {"label": "Statut opérationnel", "name": "operational_status", "type": "select",
         "options": ["active", "suspended", "inactive"],
         "help": "État opérationnel de la venue"},
    ]
    return templates.TemplateResponse(request, "form.html", {"request": request, "title": "Nouvelle venue", "fields": fields})

@router.post("/new")
def create_venue(
    dossier_id: int = Form(...),
    uf_responsabilite: str = Form(...),
    start_time: str = Form(...),
    hospital_service: str = Form(None),
    assigned_location: str = Form(None),
    attending_provider: str = Form(None),
    bed: str = Form(None),
    room: str = Form(None),
    code: str = Form(None),
    label: str = Form(None),
    venue_seq: int | None = Form(None),
    managing_department: str = Form(None),
    physical_type: str = Form(None),
    operational_status: str = Form(None),
    session=Depends(get_session)
):
    start_dt = datetime.fromisoformat(start_time)
    seq = venue_seq or get_next_sequence(session, "venue")
    v = Venue(
        dossier_id=dossier_id,
        uf_responsabilite=uf_responsabilite,
        start_time=start_dt,
        hospital_service=hospital_service,
        assigned_location=assigned_location,
        attending_provider=attending_provider,
        bed=bed,
        room=room,
        code=code,
        label=label,
        venue_seq=seq,
        managing_department=managing_department,
        physical_type=physical_type,
        operational_status=operational_status,
    )
    session.add(v); session.commit()
    emit_to_senders(v, "venue", session)
    return RedirectResponse(url="/venues", status_code=303)
