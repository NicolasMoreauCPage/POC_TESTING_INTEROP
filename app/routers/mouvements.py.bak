from fastapi import APIRouter, Depends, Request, Form, Query, HTTPException
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.templating import Jinja2Templates
from sqlmodel import select
from datetime import datetime
from app.db import get_session, get_next_sequence, peek_next_sequence
from app.models import Mouvement, Venue
from app.services.emit_on_create import emit_to_senders
from app.dependencies.ght import require_ght_context

templates = Jinja2Templates(directory="app/templates")
router = APIRouter(
    prefix="/mouvements", 
    tags=["mouvements"],
    dependencies=[Depends(require_ght_context)]
)

def get_status_badge(status):
    colors = {
        'active': 'bg-green-100 text-green-800',
        'completed': 'bg-blue-100 text-blue-800',
        'cancelled': 'bg-red-100 text-red-800',
        'pending': 'bg-yellow-100 text-yellow-800'
    }
    # Guard against None status
    if status is None:
        status = 'inconnu'
    class_name = colors.get(status, 'bg-slate-100 text-slate-800')
    return f'<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {class_name}">{status.title()}</span>'

@router.get("", response_class=HTMLResponse)
def list_mouvements(
    request: Request,
    venue_id: int = Query(..., description="ID de la venue dont on veut voir les mouvements"),
    session=Depends(get_session)
):
    # Vérifier que la venue existe et charger le contexte
    venue = session.get(Venue, venue_id)
    if not venue:
        return templates.TemplateResponse(
            request,
            "error.html",
            {
                "request": request,
                "title": "Venue introuvable",
                "message": "La venue spécifiée n'existe pas. Veuillez sélectionner une venue valide.",
                "back_url": "/dossiers"
            },
            status_code=404
        )
    
    # Charger le contexte complet pour le fil d'Ariane
    session.refresh(venue, ['dossier'])
    if venue.dossier:
        session.refresh(venue.dossier, ['patient'])
        
    # Construction de la requête filtrée par venue
    stmt = select(Mouvement).where(Mouvement.venue_id == venue_id)

    # Exécuter la requête
    mouvements = session.exec(stmt).all()

    # Préparer les lignes avec les actions détaillées
    rows = [
        {
            "cells": [
                m.mouvement_seq, 
                m.id, 
                m.venue_id, 
                m.type, 
                get_status_badge(getattr(m,'status','pending')),
                m.when.strftime("%d/%m/%Y %H:%M") if m.when else None,
                m.location,
                m.performer
            ],
            "detail_url": f"/mouvements/{m.id}",
            "edit_url": f"/mouvements/{m.id}/edit",
            "delete_url": f"/mouvements/{m.id}/delete"
        } 
        for m in mouvements
    ]

    # Construire le fil d'Ariane
    breadcrumbs = [{"label": "Mouvements", "url": "/mouvements"}]
    if venue_id and venue:
        breadcrumbs.insert(0, {"label": f"Venue #{venue.venue_seq}", "url": f"/venues/{venue_id}"})
        if venue.dossier:
            breadcrumbs.insert(0, {"label": f"Dossier #{venue.dossier.dossier_seq}", "url": f"/dossiers/{venue.dossier.id}"})
            if venue.dossier.patient:
                breadcrumbs.insert(0, {
                    "label": f"Patient: {venue.dossier.patient.family} {venue.dossier.patient.given}",
                    "url": f"/patients/{venue.dossier.patient.id}"
                })

    # Définir les filtres de recherche
    filters = [
        {
            "label": "Type",
            "name": "type",
            "type": "select",
            "placeholder": "Tous les types",
            "options": [
                {"value": "ADT^A01", "label": "Admission"},
                {"value": "ADT^A02", "label": "Transfert"},
                {"value": "ADT^A03", "label": "Sortie"},
                {"value": "ADT^A04", "label": "Inscription"}
            ]
        },
        {
            "label": "Statut",
            "name": "status",
            "type": "select",
            "placeholder": "Tous les statuts",
            "options": [
                {"value": "pending", "label": "En attente"},
                {"value": "active", "label": "En cours"},
                {"value": "completed", "label": "Terminé"},
                {"value": "cancelled", "label": "Annulé"}
            ]
        },
        {
            "label": "Localisation",
            "name": "location",
            "type": "text",
            "placeholder": "Filtrer par localisation"
        }
    ]

    # Définir les actions disponibles
    actions = [
        {
            "type": "link",
            "label": "Export FHIR",
            "url": "/mouvements/export/fhir"
        },
        {
            "type": "link",
            "label": "Export HL7",
            "url": "/mouvements/export/hl7"
        }
    ]

    # Construire le contexte complet
    ctx = {
        "request": request,
        "title": "Mouvements" if not venue_id else f"Mouvements de la venue #{venue.venue_seq}",
        "breadcrumbs": breadcrumbs,
        "headers": ["Seq", "ID", "Venue", "Type", "Status", "Date/Heure", "Localisation", "Intervenant"],
        "rows": rows,
        "context": {"venue_id": venue_id},
        "new_url": f"/mouvements/new?venue_id={venue_id}",
        "filters": filters,
        "actions": actions,
        "show_actions": True
    }

    return templates.TemplateResponse(request, "list.html", ctx)

@router.get("/{mouvement_id}", response_class=HTMLResponse)
def mouvement_detail(mouvement_id: int, request: Request, session=Depends(get_session)):
    m = session.get(Mouvement, mouvement_id)
    if not m:
        return templates.TemplateResponse(request, "not_found.html", {"request": request, "title": "Mouvement introuvable"}, status_code=404)
    return templates.TemplateResponse(request, "mouvement_detail.html", {"request": request, "mouvement": m})


@router.get("/{mouvement_id}/edit", response_class=HTMLResponse)
def edit_mouvement(mouvement_id: int, request: Request, session=Depends(get_session)):
    m = session.get(Mouvement, mouvement_id)
    if not m:
        return templates.TemplateResponse(request, "not_found.html", {"request": request, "title": "Mouvement introuvable"}, status_code=404)
    fields = [
        {"label": "Venue ID", "name": "venue_id", "type": "number", "value": m.venue_id},
        {"label": "Type (ex: ADT^A01)", "name": "type", "type": "select", "options": ["ADT^A01", "ADT^A02", "ADT^A03", "ADT^A04"], "value": m.type},
        {"label": "Quand", "name": "when", "type": "datetime-local", "value": m.when.strftime('%Y-%m-%dT%H:%M') if m.when else ''},
        {"label": "Localisation", "name": "location", "type": "text", "value": m.location},
        {"label": "Depuis (from_location)", "name": "from_location", "type": "text", "value": getattr(m,'from_location',None)},
        {"label": "Vers (to_location)", "name": "to_location", "type": "text", "value": getattr(m,'to_location',None)},
        {"label": "Raison", "name": "reason", "type": "text", "value": getattr(m,'reason',None)},
        {"label": "Intervenant", "name": "performer", "type": "text", "value": getattr(m,'performer',None)},
        {"label": "Statut", "name": "status", "type": "select", "options": ["active", "completed", "cancelled", "pending"], "value": getattr(m,'status',None)},
        {"label": "Note", "name": "note", "type": "text", "value": getattr(m,'note',None)},
        {"label": "Numéro de séquence", "name": "mouvement_seq", "type": "number", "value": m.mouvement_seq},
        {"label": "Type de mouvement", "name": "movement_type", "type": "text", "value": getattr(m, "movement_type", None)},
        {"label": "Raison du mouvement", "name": "movement_reason", "type": "text", "value": getattr(m, "movement_reason", None)},
        {"label": "Rôle de l'intervenant", "name": "performer_role", "type": "text", "value": getattr(m, "performer_role", None)},
    ]
    session.refresh(m, ["venue"])
    return templates.TemplateResponse(
        request, 
        "form.html", 
        {
            "request": request, 
            "title": "Modifier mouvement", 
            "fields": fields, 
            "action_url": f"/mouvements/{mouvement_id}/edit",
            "back_url": f"/mouvements?venue_id={m.venue_id}",
        }
    )


@router.post("/{mouvement_id}/edit")
def update_mouvement(
    mouvement_id: int,
    venue_id: int = Form(...),
    type: str = Form(...),
    when: str = Form(...),
    location: str = Form(None),
    from_location: str = Form(None),
    to_location: str = Form(None),
    reason: str = Form(None),
    performer: str = Form(None),
    status: str = Form(None),
    note: str = Form(None),
    mouvement_seq: int = Form(...),
    movement_type: str = Form(None),
    movement_reason: str = Form(None),
    performer_role: str = Form(None),
    session=Depends(get_session),
    request: Request = None,
):
    m = session.get(Mouvement, mouvement_id)
    if not m:
        return templates.TemplateResponse(request, "not_found.html", {"request": request, "title": "Mouvement introuvable"}, status_code=404)
    m.venue_id = venue_id
    m.type = type
    m.when = datetime.fromisoformat(when)
    m.location = location
    m.from_location = from_location
    m.to_location = to_location
    m.reason = reason
    m.performer = performer
    m.status = status
    m.note = note
    m.mouvement_seq = mouvement_seq
    m.movement_type = movement_type
    m.movement_reason = movement_reason
    m.performer_role = performer_role
    session.add(m); session.commit()
    emit_to_senders(m, "mouvement", session)
    return RedirectResponse(url="/mouvements", status_code=303)


@router.post("/{mouvement_id}/delete")
def delete_mouvement(mouvement_id: int, request: Request, session=Depends(get_session)):
    m = session.get(Mouvement, mouvement_id)
    if not m:
        return templates.TemplateResponse(request, "not_found.html", {"request": request, "title": "Mouvement introuvable"}, status_code=404)
    session.delete(m); session.commit()
    emit_to_senders(m, "mouvement", session)
    return RedirectResponse(url="/mouvements", status_code=303)

@router.get("/new", response_class=HTMLResponse)
def new_mouvement(
    request: Request,
    venue_id: int | None = Query(None, description="ID de la venue pour laquelle créer un mouvement (pré-rempli si fourni)"),
    session=Depends(get_session)
):
    # Si venue_id fourni en query param, l'utiliser
    # Sinon, tenter de récupérer depuis le contexte
    prefill_venue_id = venue_id
    if prefill_venue_id is None and hasattr(request.state, 'venue_context') and request.state.venue_context:
        prefill_venue_id = request.state.venue_context.id
    
    # Si toujours None, on ne peut pas créer de mouvement sans venue
    if prefill_venue_id is None:
        return templates.TemplateResponse(
            request,
            "error.html",
            {
                "request": request,
                "title": "Venue manquante",
                "message": "Impossible de créer un mouvement : aucune venue n'est spécifiée.",
                "back_url": "/dossiers"
            },
            status_code=400
        )

    # Vérifier que la venue existe
    venue = session.get(Venue, prefill_venue_id)
    if not venue:
        return templates.TemplateResponse(
            request, 
            "error.html", 
            {
                "request": request,
                "title": "Venue introuvable",
                "message": "Impossible de créer un mouvement : la venue spécifiée n'existe pas.",
                "back_url": "/venues"
            },
            status_code=404
        )
    
    next_seq = peek_next_sequence(session, "mouvement")
    now_str = datetime.now().strftime("%Y-%m-%dT%H:%M")
    
    # Structure Location Fields
    location_fields = [
        {
            "label": "Unité Fonctionnelle (UF)",
            "name": "uf_id",
            "type": "select",
            "options_url": "/structure/uf",
            "help": "Sélectionnez l'UF concernée",
            "onchange": {
                "target": "uh_id",
                "url": "/structure/uh/{value}"
            }
        },
        {
            "label": "Unité d'Hébergement (UH)",
            "name": "uh_id",
            "type": "select",
            "help": "Sélectionnez l'UH",
            "depends_on": "uf_id",
            "onchange": {
                "target": "chambre_id",
                "url": "/structure/chambres/{value}"
            }
        },
        {
            "label": "Chambre",
            "name": "chambre_id",
            "type": "select",
            "help": "Sélectionnez la chambre",
            "depends_on": "uh_id",
            "onchange": {
                "target": "lit_id",
                "url": "/structure/lits/{value}"
            }
        },
        {
            "label": "Lit",
            "name": "lit_id",
            "type": "select",
            "help": "Sélectionnez le lit",
            "depends_on": "chambre_id"
        }
    ]

    fields = [
        {"label": "Venue ID", "name": "venue_id", "type": "number", "required": True,
         "value": prefill_venue_id, "readonly": True,
         "help": "ID de la venue existante dans la base"},
        {"label": "Type (ex: ADT^A01)", "name": "type", "type": "select", 
         "options": ["ADT^A01", "ADT^A02", "ADT^A03", "ADT^A04", "ADT^A05", "ADT^A06", "ADT^A07", "ADT^A08"],
         "required": True,
         "help": "Type d'événement ADT"},
        {"label": "Quand", "name": "when", "type": "datetime-local", 
         "value": now_str, "required": True,
         "help": "Date et heure du mouvement"},
        {"label": "Localisation", "name": "location", "type": "text",
         "help": "Lieu concerné par le mouvement",
         "depends_on": ["uf_id", "uh_id", "chambre_id", "lit_id"]},
        {"label": "Depuis", "name": "from_location", "type": "text",
         "help": "Lieu de départ",
         "depends_on": ["uf_id", "uh_id", "chambre_id", "lit_id"]},
        {"label": "Vers", "name": "to_location", "type": "text",
         "help": "Lieu de destination",
         "depends_on": ["uf_id", "uh_id", "chambre_id", "lit_id"]},
        {"label": "Raison", "name": "reason", "type": "text",
         "help": "Motif du mouvement"},
        {"label": "Intervenant", "name": "performer", "type": "text",
         "help": "Personne ayant effectué le mouvement"},
        {"label": "Statut", "name": "status", "type": "select",
         "options": ["active", "completed", "cancelled", "pending"],
         "help": "État du mouvement"},
        {"label": "Note", "name": "note", "type": "text",
         "help": "Commentaire libre"},
        {"label": "Numéro de séquence", "name": "mouvement_seq", "type": "number", 
         "value": next_seq,
         "help": "Généré automatiquement si non renseigné"},
        {"label": "Type de mouvement", "name": "movement_type", "type": "select",
         "options": ["admission", "transfer", "discharge", "visit", "temporary_leave", "return"],
         "help": "Nature du mouvement"},
        {"label": "Raison du mouvement", "name": "movement_reason", "type": "text",
         "help": "Motif détaillé du mouvement"},
        {"label": "Rôle de l'intervenant", "name": "performer_role", "type": "text",
         "help": "Fonction de la personne ayant effectué le mouvement"},
    ]
    
    # Insert location fields after venue_id
    for field in reversed(location_fields):
        fields.insert(1, field)

    return templates.TemplateResponse(
        request,
        "form.html",
        {
            "request": request,
            "title": f"Nouveau mouvement pour la venue #{venue.venue_seq}",
            "fields": fields,
            "back_url": f"/mouvements?venue_id={prefill_venue_id}"
        }
    )

@router.post("/new")
def create_mouvement(
    request: Request,
    venue_id: int = Form(...),
    type: str = Form(...),
    when: str = Form(...),
    uf_id: int = Form(None),
    uh_id: int = Form(None),
    chambre_id: int = Form(None),
    lit_id: int = Form(None),
    location: str = Form(None),
    from_location: str = Form(None),
    to_location: str = Form(None),
    reason: str = Form(None),
    performer: str = Form(None),
    status: str = Form(None),
    note: str = Form(None),
    mouvement_seq: int | None = Form(None),
    movement_type: str = Form(None),
    movement_reason: str = Form(None),
    performer_role: str = Form(None),
    session=Depends(get_session),
):
    when_dt = datetime.fromisoformat(when)
    seq = mouvement_seq or get_next_sequence(session, "mouvement")
    m = Mouvement(
        venue_id=venue_id,
        type=type,
        when=when_dt,
        location=location,
        from_location=from_location,
        to_location=to_location,
        reason=reason,
        performer=performer,
        status=status,
        note=note,
        mouvement_seq=seq,
        movement_type=movement_type,
        movement_reason=movement_reason,
        performer_role=performer_role,
    )
    session.add(m)
    session.commit()
    emit_to_senders(m, "mouvement", session)
    return RedirectResponse(url=f"/mouvements?venue_id={venue_id}", status_code=303)
